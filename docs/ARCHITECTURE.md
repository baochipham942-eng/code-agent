# Code Agent - æ¶æ„è®¾è®¡æ–‡æ¡£

> ç‰ˆæœ¬: 2.0
> æ—¥æœŸ: 2026-01-17
> ä½œè€…: Lin Chen

---

## ä¸€ã€ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### 1.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Code Agent Architecture                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                         Presentation Layer (Electron)                   â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  Chat View   â”‚ â”‚ Workspace    â”‚ â”‚  Generation  â”‚ â”‚   Settings   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  Component   â”‚ â”‚ Explorer     â”‚ â”‚  Selector    â”‚ â”‚   Panel      â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ Tool Viewer  â”‚ â”‚  Todo List   â”‚ â”‚ Diff Viewer  â”‚ â”‚ Prompt Viewerâ”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â”‚ IPC                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                         Application Layer (Main Process)                â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚                        Agent Orchestrator                         â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ Generation â”‚ â”‚   Model    â”‚ â”‚   Tool     â”‚ â”‚  Session   â”‚    â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  Manager   â”‚ â”‚  Router    â”‚ â”‚  Registry  â”‚ â”‚  Manager   â”‚    â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚                        Core Services                              â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ Permission â”‚ â”‚   File     â”‚ â”‚  Process   â”‚ â”‚   Config   â”‚    â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  Service   â”‚ â”‚  Service   â”‚ â”‚  Service   â”‚ â”‚  Service   â”‚    â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                         Tool Layer                                      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚                    Tool Implementation                           â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  Gen 1 Tools    Gen 2 Tools    Gen 3 Tools    Gen 4 Tools       â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  bash   â”‚   â”‚  glob   â”‚   â”‚  task   â”‚   â”‚  skill  â”‚         â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  read   â”‚   â”‚  grep   â”‚   â”‚ todoWriteâ”‚  â”‚webFetch â”‚         â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  write  â”‚   â”‚ listDir â”‚   â”‚askUser  â”‚   â”‚webSearchâ”‚         â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  edit   â”‚   â”‚  mcp    â”‚   â”‚planMode â”‚   â”‚ hooks   â”‚         â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                         External Layer                                  â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚ â”‚
â”‚  â”‚  â”‚  DeepSeek  â”‚ â”‚   Claude   â”‚ â”‚   OpenAI   â”‚ â”‚   Local    â”‚          â”‚ â”‚
â”‚  â”‚  â”‚    API     â”‚ â”‚    API     â”‚ â”‚    API     â”‚ â”‚   Model    â”‚          â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚ â”‚
â”‚  â”‚  â”‚   File     â”‚ â”‚  Process   â”‚ â”‚  Network   â”‚                         â”‚ â”‚
â”‚  â”‚  â”‚  System    â”‚ â”‚ (Shell)    â”‚ â”‚  (HTTP)    â”‚                         â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æŠ€æœ¯æ ˆé€‰å‹

| å±‚çº§ | æŠ€æœ¯é€‰å‹ | è¯´æ˜ |
|------|----------|------|
| **æ¡Œé¢æ¡†æ¶** | Electron 33+ | è·¨å¹³å°ï¼Œç”Ÿæ€æˆç†Ÿ |
| **å‰ç«¯æ¡†æ¶** | React 18 + TypeScript 5.6 | ç»„ä»¶åŒ–å¼€å‘ |
| **çŠ¶æ€ç®¡ç†** | Zustand 5 | è½»é‡çº§çŠ¶æ€ç®¡ç† |
| **UI ç»„ä»¶** | Tailwind CSS 3.4 | å¿«é€Ÿå¼€å‘ |
| **æ„å»ºå·¥å…·** | esbuild + Vite | å¿«é€Ÿå¼€å‘ä½“éªŒ |
| **IPC é€šä¿¡** | Electron IPC + Type-safe | ä¸»è¿›ç¨‹/æ¸²æŸ“è¿›ç¨‹é€šä¿¡ |
| **æœ¬åœ°å­˜å‚¨** | SQLite (better-sqlite3) | ä¼šè¯/é…ç½®æŒä¹…åŒ– |
| **äº‘ç«¯å­˜å‚¨** | Supabase + pgvector | åŒæ­¥ + å‘é‡å­˜å‚¨ |
| **AI æ¨¡å‹** | DeepSeek API (ä¸»è¦) | å¤šæ¨¡å‹æ”¯æŒ |

---

## äºŒã€Gen1 å®Œæ•´æ•°æ®æµç¨‹

### 2.1 Happy Path æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Gen1 ç”¨æˆ·éœ€æ±‚åˆ°äº§å“çš„å®Œæ•´æµç¨‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ‘¤ ç”¨æˆ·è¾“å…¥éœ€æ±‚   â”‚ "å¸®æˆ‘å†™ä¸€ä¸ªè´ªåƒè›‡æ¸¸æˆ"
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼ [IPC: agent:send-message]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ä¸»è¿›ç¨‹ - AgentOrchestrator                          â”‚
â”‚  1. åˆ›å»º User Message { id, role: 'user', content, timestamp }              â”‚
â”‚  2. è·å– ModelConfig (DeepSeek API Key, Model ID)                           â”‚
â”‚  3. åˆ›å»º AgentLoop å®ä¾‹                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              AgentLoop.run()                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€ è¿­ä»£ N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                                                                   â”‚    â”‚
â”‚   â”‚  1ï¸âƒ£ INFERENCE é˜¶æ®µ                                               â”‚    â”‚
â”‚   â”‚     buildModelMessages():                                         â”‚    â”‚
â”‚   â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚   â”‚     â”‚ [                                                        â”‚ â”‚    â”‚
â”‚   â”‚     â”‚   { role: 'system', content: Gen1 System Prompt },       â”‚ â”‚    â”‚
â”‚   â”‚     â”‚   { role: 'user', content: 'å¸®æˆ‘å†™ä¸€ä¸ªè´ªåƒè›‡æ¸¸æˆ' },      â”‚ â”‚    â”‚
â”‚   â”‚     â”‚   { role: 'assistant', content: 'Calling xxx(...)' },    â”‚ â”‚    â”‚
â”‚   â”‚     â”‚   { role: 'user', content: 'Tool results:\n[...]' },     â”‚ â”‚    â”‚
â”‚   â”‚     â”‚   ...                                                    â”‚ â”‚    â”‚
â”‚   â”‚     â”‚ ]                                                        â”‚ â”‚    â”‚
â”‚   â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚   â”‚                                                                   â”‚    â”‚
â”‚   â”‚     ModelRouter.inference() â†’ è°ƒç”¨ DeepSeek API                   â”‚    â”‚
â”‚   â”‚                                                                   â”‚    â”‚
â”‚   â”‚  2ï¸âƒ£ å“åº”è§£æ                                                     â”‚    â”‚
â”‚   â”‚     ModelResponse { type: 'tool_use' | 'text', ... }              â”‚    â”‚
â”‚   â”‚                                                                   â”‚    â”‚
â”‚   â”‚  3ï¸âƒ£ å“åº”å¤„ç†åˆ†æ”¯                                                 â”‚    â”‚
â”‚   â”‚     â”Œâ”€ type === 'text' â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚   â”‚     â”‚ â€¢ åˆ›å»º assistantMessage { content: '...' }               â”‚ â”‚    â”‚
â”‚   â”‚     â”‚ â€¢ onEvent({ type: 'message' }) â†’ UI æ˜¾ç¤º                  â”‚ â”‚    â”‚
â”‚   â”‚     â”‚ â€¢ BREAK å¾ªç¯                                              â”‚ â”‚    â”‚
â”‚   â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚   â”‚     â”Œâ”€ type === 'tool_use' â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚   â”‚     â”‚ â€¢ åˆ›å»º assistantMessage { toolCalls: [...] }             â”‚ â”‚    â”‚
â”‚   â”‚     â”‚ â€¢ onEvent({ type: 'message' }) â†’ UI æ˜¾ç¤ºå·¥å…·è°ƒç”¨          â”‚ â”‚    â”‚
â”‚   â”‚     â”‚ â€¢ æ‰§è¡Œå·¥å…· (è§ä¸‹æ–¹è¯¦ç»†æµç¨‹)                               â”‚ â”‚    â”‚
â”‚   â”‚     â”‚ â€¢ åˆ›å»º toolMessage { toolResults: [...] }                â”‚ â”‚    â”‚
â”‚   â”‚     â”‚ â€¢ CONTINUE å¾ªç¯                                           â”‚ â”‚    â”‚
â”‚   â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚   â”‚                                                                   â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                             â”‚
â”‚   onEvent({ type: 'agent_complete' })                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼ [IPC: agent:event]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          æ¸²æŸ“è¿›ç¨‹ - React UI                                â”‚
â”‚                                                                             â”‚
â”‚  useAgent Hook ç›‘å¬äº‹ä»¶:                                                    â”‚
â”‚  - 'message' â†’ ChatView/MessageBubble æ˜¾ç¤ºæ¶ˆæ¯                             â”‚
â”‚  - 'tool_call_start' â†’ MessageBubble æ˜¾ç¤º "Running..."                     â”‚
â”‚  - 'tool_call_end' â†’ MessageBubble æ˜¾ç¤ºç»“æœ (åŒ¹é… toolCallId)              â”‚
â”‚  - 'agent_complete' â†’ è§£é”è¾“å…¥                                             â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 å·¥å…·æ‰§è¡Œè¯¦ç»†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å·¥å…·æ‰§è¡Œæµç¨‹ (executeToolsWithHooks)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¾“å…¥: toolCalls = [
  { id: "call_abc123", name: "edit_file", arguments: {...} },
  { id: "call_def456", name: "bash", arguments: {...} }
]

FOR EACH toolCall:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚  1ï¸âƒ£ å‘é€å¼€å§‹äº‹ä»¶                                                           â”‚
â”‚     onEvent({ type: 'tool_call_start', data: toolCall })                    â”‚
â”‚     â†’ UI: MessageBubble æ˜¾ç¤º "Running edit_file..."                         â”‚
â”‚                                                                             â”‚
â”‚  2ï¸âƒ£ æ‰§è¡Œå·¥å…·                                                               â”‚
â”‚     ToolExecutor.execute(name, arguments, context)                          â”‚
â”‚     â”‚                                                                       â”‚
â”‚     â”œâ”€ æŸ¥æ‰¾å·¥å…·: ToolRegistry.get('edit_file')                             â”‚
â”‚     â”‚                                                                       â”‚
â”‚     â”œâ”€ æƒé™æ£€æŸ¥ (å¦‚éœ€è¦):                                                  â”‚
â”‚     â”‚  â”œâ”€ autoApprove è®¾ç½®? â†’ è‡ªåŠ¨æ‰¹å‡†                                     â”‚
â”‚     â”‚  â””â”€ å¦åˆ™ â†’ onEvent({ type: 'permission_request' })                   â”‚
â”‚     â”‚            ç­‰å¾…ç”¨æˆ·å“åº”                                               â”‚
â”‚     â”‚                                                                       â”‚
â”‚     â””â”€ å·¥å…·æ‰§è¡Œ:                                                           â”‚
â”‚        tool.execute(arguments, context)                                     â”‚
â”‚        â†’ ToolExecutionResult { success, output?, error? }                  â”‚
â”‚                                                                             â”‚
â”‚  3ï¸âƒ£ æ„å»ºç»“æœ                                                               â”‚
â”‚     ToolResult {                                                            â”‚
â”‚       toolCallId: "call_abc123",  // âš ï¸ å…³é”®: å¿…é¡»ä¸ toolCall.id ä¸€è‡´      â”‚
â”‚       success: true,                                                        â”‚
â”‚       output: "Edited file: ...",                                          â”‚
â”‚       duration: 45                                                          â”‚
â”‚     }                                                                       â”‚
â”‚                                                                             â”‚
â”‚  4ï¸âƒ£ å‘é€ç»“æŸäº‹ä»¶                                                           â”‚
â”‚     onEvent({ type: 'tool_call_end', data: toolResult })                    â”‚
â”‚     â†’ UI: MessageBubble é€šè¿‡ toolCallId åŒ¹é…å¹¶æ˜¾ç¤ºç»“æœ                      â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¾“å‡º: toolResults = [
  { toolCallId: "call_abc123", success: true, output: "...", duration: 45 },
  { toolCallId: "call_def456", success: true, output: "...", duration: 120 }
]
```

### 2.3 æ¶ˆæ¯æ ¼å¼åŒ–æµç¨‹ (buildModelMessages)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    buildModelMessages() æ¶ˆæ¯æ„å»ºæµç¨‹                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å†…éƒ¨ messages æ•°ç»„:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [                                                                          â”‚
â”‚   { role: 'user', content: 'å¸®æˆ‘å†™è´ªåƒè›‡' },                               â”‚
â”‚   { role: 'assistant', content: '', toolCalls: [{...}] },                  â”‚
â”‚   { role: 'tool', content: JSON.stringify(results), toolResults: [...] }, â”‚
â”‚   { role: 'assistant', content: 'æˆ‘æ¥å¸®ä½ ...' },                           â”‚
â”‚ ]                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼ buildModelMessages()
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è½¬æ¢è§„åˆ™:                                                                   â”‚
â”‚                                                                            â”‚
â”‚ 1. role='tool' â†’ role='user', content='Tool results:\n[...]'              â”‚
â”‚                                                                            â”‚
â”‚ 2. role='assistant' + toolCalls â†’ content='Calling xxx({...})'            â”‚
â”‚    âš ï¸ é—®é¢˜: JSON.stringify(arguments) å¯¼è‡´å¤§é‡ä»£ç è¢«åºåˆ—åŒ–                â”‚
â”‚                                                                            â”‚
â”‚ 3. å…¶ä»–æ¶ˆæ¯ä¿æŒåŸæ ·                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
å‘é€ç»™æ¨¡å‹çš„ modelMessages:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [                                                                          â”‚
â”‚   { role: 'system', content: Gen1SystemPrompt },                           â”‚
â”‚   { role: 'user', content: 'å¸®æˆ‘å†™è´ªåƒè›‡' },                               â”‚
â”‚   { role: 'assistant', content: 'Calling edit_file({"file_path":...'       â”‚
â”‚                                  '"old_string":"// æ ¹æ®æ–¹å‘ç»˜åˆ¶çœ¼ç›\n...' }, â”‚ â¬…ï¸ é—®é¢˜!
â”‚   { role: 'user', content: 'Tool results:\n[{"toolCallId":...' },          â”‚
â”‚   { role: 'assistant', content: 'æˆ‘æ¥å¸®ä½ ...' },                           â”‚
â”‚ ]                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€ID ä½“ç³»ä¸åŒæ­¥é—®é¢˜

### 3.1 å½“å‰ ID ç”Ÿæˆæ–¹å¼ (é—®é¢˜åˆ†æ)

| ä½ç½® | ID ç±»å‹ | ç”Ÿæˆæ–¹å¼ | é—®é¢˜ |
|------|---------|----------|------|
| **å‰ç«¯ useAgent.ts** | message.id | `Date.now().toString()` | æ¯«ç§’çº§ï¼Œå¯èƒ½ç¢°æ’ |
| **åç«¯ AgentLoop.ts** | message.id | `${Date.now()}-${random}` | æ ¼å¼ä¸ä¸€è‡´ |
| **æ¨¡å‹å“åº”** | toolCall.id | `call_xxx` (æ¨¡å‹ç”Ÿæˆ) | ä¸å¯æ§ |
| **æ–‡æœ¬è§£æå›é€€** | toolCall.id | `text-${Date.now()}` | åˆä¸€ç§æ ¼å¼ |
| **MCPClient.ts** | toolCallId | `''` (ç©ºå­—ç¬¦ä¸²) | æ°¸è¿œæ— æ³•åŒ¹é… |

### 3.2 ID æµè½¬å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ID æµè½¬ä¸åŒ¹é…                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1ï¸âƒ£ æ¶ˆæ¯ ID æµè½¬
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ å‰ç«¯åˆ›å»º User Message                                                â”‚
   â”‚   id: "1705234567890" (Date.now().toString())                       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ IPC
                          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ åç«¯åˆ›å»º Assistant Message                                           â”‚
   â”‚   id: "1705234567900-abc123def" (Date.now()-random)                 â”‚
   â”‚   âš ï¸ æ ¼å¼ä¸ä¸€è‡´!                                                    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Supabase åŒæ­¥                                                        â”‚
   â”‚   å­˜å‚¨ä¸¤ç§æ ¼å¼çš„ ID                                                  â”‚
   â”‚   è·¨è®¾å¤‡æ—¶å¯èƒ½å‡ºç°é‡å¤/å†²çª                                          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2ï¸âƒ£ ToolCall ID æµè½¬
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ æ¨¡å‹è¿”å› ToolCall                                                    â”‚
   â”‚   id: "call_abc123" (æ¨¡å‹ç”Ÿæˆ, OpenAI æ ¼å¼)                         â”‚
   â”‚   æˆ–: "toolu_01A..." (Claude æ ¼å¼)                                  â”‚
   â”‚   æˆ–: "text-1705234567890" (æ–‡æœ¬è§£æå›é€€)                           â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ åˆ›å»º ToolResult                                                      â”‚
   â”‚   toolCallId: toolCall.id  (å¿…é¡»å®Œå…¨åŒ¹é…)                           â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ tool_call_end äº‹ä»¶
                          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ å‰ç«¯åŒ¹é… (useAgent.ts)                                               â”‚
   â”‚   tc.id === event.data.toolCallId                                   â”‚
   â”‚   âš ï¸ å¦‚æœæ ¼å¼ä¸ä¸€è‡´ï¼ŒåŒ¹é…å¤±è´¥ï¼Œç»“æœæ— æ³•æ˜¾ç¤º!                        â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 é£é™©åœºæ™¯

**åœºæ™¯ 1: å·¥å…·ç»“æœæ— æ³•æ˜¾ç¤º**
```
1. æ¨¡å‹è¿”å› toolCall.id = "call_abc123"
2. æ‰§è¡Œå·¥å…·ï¼Œåˆ›å»º toolResult.toolCallId = "call_abc123"
3. å‘é€ tool_call_end äº‹ä»¶
4. å‰ç«¯æ­¤æ—¶ lastMessage.toolCalls å¯èƒ½å·²å˜åŒ–ï¼ˆç«æ€ï¼‰
5. tc.id === toolCallId åŒ¹é…å¤±è´¥
6. ç»“æœä¸¢å¤±ï¼Œç”¨æˆ·çœ‹åˆ°å·¥å…·ä¸€ç›´ "Running..."
```

**åœºæ™¯ 2: è·¨è®¾å¤‡åŒæ­¥å†²çª**
```
è®¾å¤‡ A:
- Message ID: "1705280000" (å‰ç«¯æ ¼å¼)
- ä¸Šä¼ åˆ° Supabase

è®¾å¤‡ B:
- æ‹‰å– Message ID: "1705280000"
- æœ¬åœ°ä¹Ÿåˆ›å»ºäº† "1705280000" (æ¯«ç§’ç¢°æ’)
- æ•°æ®è¦†ç›–/ä¸¢å¤±
```

**åœºæ™¯ 3: MCP å·¥å…·ç»“æœæ°¸ä¹…ä¸¢å¤±**
```
1. è°ƒç”¨ MCP å·¥å…·
2. MCPClient è¿”å› toolCallId: '' (ç©º)
3. å‰ç«¯æ— æ³•åŒ¹é…ä»»ä½• toolCall
4. MCP å·¥å…·ç»“æœæ°¸ä¸æ˜¾ç¤º
```

---

## å››ã€æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 4.1 AgentOrchestrator

**ä½ç½®**: `src/main/agent/AgentOrchestrator.ts`

**èŒè´£**:
- ç®¡ç†å¯¹è¯æ¶ˆæ¯å†å²
- å¤„ç†æƒé™è¯·æ±‚/å“åº”
- è·å–æ¨¡å‹é…ç½®
- åˆ›å»ºå’Œå¯åŠ¨ AgentLoop
- å¤„ç†ä»£é™…åˆ‡æ¢

**å…³é”®æ–¹æ³•**:
```typescript
sendMessage(content: string): Promise<void>
  â”œâ”€ åˆ›å»º user message
  â”œâ”€ æ·»åŠ åˆ°å†å²
  â”œâ”€ è·å– ModelConfig
  â”œâ”€ åˆ›å»º AgentLoop
  â””â”€ è¿è¡Œ loop

requestPermission(request): Promise<boolean>
  â”œâ”€ æ£€æŸ¥ AUTO_TEST æ¨¡å¼
  â”œâ”€ æ£€æŸ¥ autoApprove è®¾ç½®
  â””â”€ å‘é€æƒé™è¯·æ±‚äº‹ä»¶ï¼Œç­‰å¾…ç”¨æˆ·å“åº”

handlePermissionResponse(requestId, response)
  â””â”€ è°ƒç”¨ resolve(response)
```

### 4.2 AgentLoop

**ä½ç½®**: `src/main/agent/AgentLoop.ts`

**æ ¸å¿ƒå¾ªç¯**:
```typescript
while (!isCancelled && iterations < 50) {
  iterations++;

  // 1. æ¨ç†
  response = await inference();

  // 2. å¤„ç†å“åº”
  if (response.type === 'text') {
    // Stop Hook éªŒè¯ â†’ åˆ›å»ºåŠ©æ‰‹æ¶ˆæ¯ â†’ å‘é€äº‹ä»¶ â†’ BREAK
  }

  if (response.type === 'tool_use') {
    // Pre-Tool Hook â†’ æ‰§è¡Œå·¥å…· â†’ Anti-pattern Detection â†’ Post-Tool Hook
    // åˆ›å»ºå·¥å…·ç»“æœæ¶ˆæ¯ â†’ CONTINUE
  }
}
```

**å¢å¼ºåŠŸèƒ½**:

1. **ä»»åŠ¡å¤æ‚åº¦åˆ†æ** - åœ¨ `run()` å¼€å§‹æ—¶è‡ªåŠ¨æ£€æµ‹ä»»åŠ¡ç±»å‹
2. **Anti-pattern Detection** - æ£€æµ‹è¿ç»­è¯»æ“ä½œï¼Œé˜²æ­¢æ— é™å¾ªç¯
3. **Planning Hooks** - é›†æˆè§„åˆ’ç³»ç»Ÿçš„ç”Ÿå‘½å‘¨æœŸé’©å­

### 4.3 ä»»åŠ¡å¤æ‚åº¦åˆ†æç³»ç»Ÿ

**ä½ç½®**: `src/main/planning/TaskComplexityAnalyzer.ts`

**åŠŸèƒ½**: åœ¨ AI æ‰§è¡Œå‰è‡ªåŠ¨æ£€æµ‹ä»»åŠ¡å¤æ‚åº¦ï¼Œæ³¨å…¥ç›¸åº”çš„æ‰§è¡Œç­–ç•¥æç¤ºã€‚

```
ç”¨æˆ·è¾“å…¥ â†’ å¤æ‚åº¦åˆ†æ â†’ æ³¨å…¥æç¤º â†’ AI æ‰§è¡Œ
              â†“
      "create snake game"
              â†“
      Detected: SIMPLE (85%)
              â†“
      AI æ”¶åˆ°: "Skip planning, use write_file NOW"
```

**å¤æ‚åº¦åˆ†ç±»**:

| å¤æ‚åº¦ | æ£€æµ‹æŒ‡æ ‡ | å»ºè®®è¡Œä¸º | å·¥å…·è°ƒç”¨æ¬¡æ•° |
|--------|----------|----------|--------------|
| **SIMPLE** | "create a"ã€çŸ­æ¶ˆæ¯ã€å•æ–‡ä»¶ä»»åŠ¡ | è·³è¿‡è§„åˆ’ï¼Œç›´æ¥ `write_file` | 1-3 æ¬¡ |
| **MODERATE** | "add feature"ã€"fix bug" | ç®€çŸ­è§„åˆ’ï¼ˆ3-5 é¡¹ï¼‰ | 5-10 æ¬¡ |
| **COMPLEX** | "refactor"ã€"migrate"ã€å¤šæ­¥éª¤ | å®Œæ•´è§„åˆ’ï¼Œåˆ†é˜¶æ®µæ‰§è¡Œ | 10-30+ æ¬¡ |

**æ£€æµ‹å…³é”®è¯**:

```typescript
// ç®€å•ä»»åŠ¡
SIMPLE_KEYWORDS = ['create a', 'make a', 'snake game', 'calculator', 'åˆ›å»ºä¸€ä¸ª', 'è´ªåƒè›‡']

// å¤æ‚ä»»åŠ¡
COMPLEX_KEYWORDS = ['refactor', 'migrate', 'system', 'architecture', 'é‡æ„', 'è¿ç§»', 'ç³»ç»Ÿ']

// ä¸­ç­‰ä»»åŠ¡
MODERATE_KEYWORDS = ['add feature', 'implement', 'fix bug', 'æ·»åŠ åŠŸèƒ½', 'ä¿®å¤']
```

### 4.4 è§„åˆ’ç³»ç»Ÿ (Planning System)

**ä½ç½®**: `src/main/planning/`

**ç»„ä»¶ç»“æ„**:

```
planning/
â”œâ”€â”€ PlanManager.ts           # è®¡åˆ’æŒä¹…åŒ–ç®¡ç†
â”œâ”€â”€ HooksEngine.ts           # ç”Ÿå‘½å‘¨æœŸé’©å­å¼•æ“
â”œâ”€â”€ ErrorTracker.ts          # é”™è¯¯è¿½è¸ª (3-Strike Rule)
â”œâ”€â”€ FindingsManager.ts       # å‘ç°ç®¡ç†
â”œâ”€â”€ TaskComplexityAnalyzer.ts # ä»»åŠ¡å¤æ‚åº¦åˆ†æ
â”œâ”€â”€ PlanningService.ts       # ç»Ÿä¸€æœåŠ¡å…¥å£
â””â”€â”€ types.ts                 # ç±»å‹å®šä¹‰
```

**HooksEngine é’©å­**:

| é’©å­ | è§¦å‘æ—¶æœº | åŠŸèƒ½ |
|------|----------|------|
| `onSessionStart` | ä¼šè¯å¼€å§‹ | æ£€æŸ¥æœªå®Œæˆè®¡åˆ’ï¼Œé‡ç½®è®¡æ•°å™¨ |
| `preToolUse` | å·¥å…·æ‰§è¡Œå‰ | æ³¨å…¥é”™è¯¯å†å²ï¼Œæé†’å½“å‰ä»»åŠ¡ |
| `postToolUse` | å·¥å…·æ‰§è¡Œå | 2-Action è§„åˆ™ï¼Œæ›´æ–°è¿›åº¦æé†’ |
| `onStop` | AI å‡†å¤‡åœæ­¢ | éªŒè¯è®¡åˆ’å®Œæˆåº¦ï¼Œå†³å®šæ˜¯å¦å¼ºåˆ¶ç»§ç»­ |
| `onError` | å‘ç”Ÿé”™è¯¯ | è®°å½•é”™è¯¯ï¼Œæ£€æŸ¥ 3-Strike è§„åˆ™ |

**Stop Hook ç­–ç•¥** (é˜²æ­¢è¿‡åº¦å¹²é¢„):

```typescript
// å…è®¸åœæ­¢çš„æƒ…å†µ
if (!plan) return { shouldContinue: true };                    // æ— è®¡åˆ’
if (plan.metadata.totalSteps <= 4) return { shouldContinue: true };  // å°è®¡åˆ’
if (completedSteps >= totalSteps / 2) return { shouldContinue: true }; // å®Œæˆè¿‡åŠ

// å¼ºåˆ¶ç»§ç»­çš„æƒ…å†µ (éœ€éªŒè¯)
if (incompleteCount > 3 && completedSteps < totalSteps / 2) {
  return { shouldContinue: false, injectContext: warning };
}
```

### 4.5 Anti-pattern Detection

**ä½ç½®**: `AgentLoop.ts` å†…ç½®

**åŠŸèƒ½**: æ£€æµ‹ AI é™·å…¥æ— é™è¯»å–å¾ªç¯çš„æƒ…å†µã€‚

**æ£€æµ‹è§„åˆ™**:

| é˜¶æ®µ | é˜ˆå€¼ | è§¦å‘æ¡ä»¶ | è­¦å‘Šå†…å®¹ |
|------|------|----------|----------|
| **åˆ›å»ºå‰** | 5 æ¬¡ | è¿ç»­ 5 æ¬¡ read æ“ä½œ | "åœæ­¢é˜…è¯»ï¼Œç«‹å³åˆ›å»ºï¼" |
| **åˆ›å»ºå** | 10 æ¬¡ | å†™å…¥åè¿ç»­ 10 æ¬¡ read | "ä»»åŠ¡å¯èƒ½å·²å®Œæˆï¼Œåœæ­¢è¿‡åº¦éªŒè¯ï¼" |

**å®ç°é€»è¾‘**:

```typescript
// è·Ÿè¸ªçŠ¶æ€
private consecutiveReadOps: number = 0;
private hasWrittenFile: boolean = false;

// å·¥å…·æ‰§è¡Œå
if (writeTools.includes(toolName)) {
  this.hasWrittenFile = true;
  this.consecutiveReadOps = 0;
} else if (readOnlyTools.includes(toolName)) {
  this.consecutiveReadOps++;

  const threshold = this.hasWrittenFile ? 10 : 5;
  if (this.consecutiveReadOps >= threshold) {
    this.injectSystemMessage(warningMessage);
  }
}
```

**è§£å†³çš„é—®é¢˜**:
- AI åˆ›å»ºæ–‡ä»¶åé™·å…¥æ— é™éªŒè¯å¾ªç¯ï¼ˆå¦‚åå¤è¯»å–åŒä¸€æ–‡ä»¶ä¸åŒè¡Œï¼‰
- AI åœ¨åˆ›å»ºä»»åŠ¡ä¸­è¿‡åº¦ç ”ç©¶è€Œä¸åŠ¨æ‰‹
- Stop Hook è¿‡äºæ¿€è¿›å¯¼è‡´çš„å¼ºåˆ¶ç»§ç»­

### 4.6 ModelRouter

**ä½ç½®**: `src/main/model/ModelRouter.ts`

**æ”¯æŒçš„æ¨¡å‹æä¾›å•†**:
| Provider | æ¨¡å‹ | ç‰¹æ€§ |
|----------|------|------|
| DeepSeek | deepseek-chat, deepseek-reasoner | ä¸»è¦ä½¿ç”¨ |
| OpenAI | gpt-4o, gpt-4o-mini | å¤‡é€‰ |
| Claude | claude-sonnet-4, claude-opus-4 | é«˜çº§æ¨ç† |
| Groq | llama-3.3-70b | å¿«é€Ÿæ¨ç† |
| æ™ºè°± | glm-4-plus | ä¸­æ–‡ä¼˜åŒ– |
| é€šä¹‰åƒé—® | qwen-max, qwen-coder-plus | ä»£ç ä¸“ç”¨ |
| Moonshot | moonshot-v1-128k | è¶…é•¿ä¸Šä¸‹æ–‡ |

### 4.7 ToolRegistry & ToolExecutor

**ä½ç½®**: `src/main/tools/`

**å·¥å…·å®šä¹‰æ ¼å¼**:
```typescript
interface Tool {
  name: string;
  description: string;
  inputSchema: JSONSchema;
  generations: string[];        // æ”¯æŒçš„ä»£é™…
  requiresPermission: boolean;
  permissionLevel: 'read' | 'write' | 'execute' | 'network';
  execute: (params, context) => Promise<ToolExecutionResult>;
}
```

**Gen1 å·¥å…·é›†**:
| å·¥å…· | åŠŸèƒ½ | æƒé™ |
|------|------|------|
| `bash` | æ‰§è¡Œ shell å‘½ä»¤ | execute |
| `read_file` | è¯»å–æ–‡ä»¶å†…å®¹ | read |
| `write_file` | åˆ›å»º/è¦†ç›–æ–‡ä»¶ | write |
| `edit_file` | ç²¾ç¡®ç¼–è¾‘æ–‡ä»¶ | write |

---

## äº”ã€å‰ç«¯ç»„ä»¶æ¶æ„

### 5.1 å…³é”®ç»„ä»¶

| ç»„ä»¶ | æ–‡ä»¶ | èŒè´£ |
|------|------|------|
| **ChatView** | `ChatView.tsx` | ä¸»èŠå¤©è§†å›¾ï¼Œæ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨ |
| **ChatInput** | `ChatInput.tsx` | æ¶ˆæ¯è¾“å…¥æ¡† |
| **MessageBubble** | `MessageBubble.tsx` | æ¶ˆæ¯æ°”æ³¡ + å·¥å…·è°ƒç”¨æ˜¾ç¤º |
| **ToolCallDisplay** | (in MessageBubble) | å·¥å…·è°ƒç”¨å¯æŠ˜å é¢æ¿ |
| **Sidebar** | `Sidebar.tsx` | ä¼šè¯åˆ—è¡¨ + æœç´¢ |

### 5.2 useAgent Hook äº‹ä»¶å¤„ç†

```typescript
// src/renderer/hooks/useAgent.ts

ç›‘å¬ IPC äº‹ä»¶: agent:event

case 'message':
  // æ·»åŠ æ–°æ¶ˆæ¯åˆ°ä¼šè¯
  sessionStore.addMessage(event.data);

case 'tool_call_start':
  // æ›´æ–°å·¥å…·çŠ¶æ€ä¸º "running"
  // (é€šè¿‡ toolCall.id åŒ¹é…)

case 'tool_call_end':
  // é€šè¿‡ toolCallId æ‰¾åˆ°å¯¹åº”çš„ toolCall
  // æ›´æ–°å…¶ result å­—æ®µ
  const updatedToolCalls = lastMessage.toolCalls.map(tc =>
    tc.id === event.data.toolCallId
      ? { ...tc, result: event.data }
      : tc
  );

case 'permission_request':
  // æ˜¾ç¤ºæƒé™è¯·æ±‚å¯¹è¯æ¡†

case 'agent_complete':
  // è§£é”è¾“å…¥ï¼Œå…è®¸æ–°æ¶ˆæ¯
```

---

## å…­ã€UI/UX é—®é¢˜åˆ†æ

### 6.1 å·¥å…·è°ƒç”¨æ˜¾ç¤ºé—®é¢˜

**å½“å‰é—®é¢˜** (å¦‚æˆªå›¾æ‰€ç¤º):
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¤– Agent                                                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â–¶ edit_file                                              âœ“ Success      â”‚ â”‚
â”‚ â”‚   Arguments:                                                            â”‚ â”‚
â”‚ â”‚   {                                                                     â”‚ â”‚
â”‚ â”‚     "file_path": "snake_game_complete.html",                           â”‚ â”‚
â”‚ â”‚     "old_string": "// æ ¹æ®æ–¹å‘ç»˜åˆ¶çœ¼ç›\n          const eyeSize = ... â”‚ â”‚
â”‚ â”‚       ... (å‡ ç™¾è¡Œä»£ç è¢«åºåˆ—åŒ–ä¸º JSON) ...                              â”‚ â”‚
â”‚ â”‚     "new_string": "// æ ¹æ®æ–¹å‘ç»˜åˆ¶çœ¼ç›\n          const eyeSize = ... â”‚ â”‚
â”‚ â”‚       ... (å‡ ç™¾è¡Œä»£ç è¢«åºåˆ—åŒ–ä¸º JSON) ...                              â”‚ â”‚
â”‚ â”‚   }                                                                     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜:
1. âŒ ä»£ç è¢« JSON.stringifyï¼Œ\n æ˜¾ç¤ºä¸ºå­—é¢é‡
2. âŒ æ²¡æœ‰è¯­æ³•é«˜äº®
3. âŒ æ²¡æœ‰æŠ˜å /æˆªæ–­
4. âŒ ç”¨æˆ·ä½“éªŒæå·®
```

**æˆç†Ÿäº§å“åšæ³•å¯¹æ¯”**:

| æ–¹é¢ | Claude Code | Cursor | å½“å‰äº§å“ |
|------|-------------|--------|---------|
| edit_file æ˜¾ç¤º | Diff è§†å›¾ (çº¢ç»¿å¯¹æ¯”) | å†…è” diff | âŒ åŸå§‹ JSON |
| å‚æ•°æ‘˜è¦ | "Editing file.ts (15 lines)" | ç®€çŸ­æ‘˜è¦ | âŒ å®Œæ•´å‚æ•° |
| é»˜è®¤çŠ¶æ€ | æŠ˜å  | æŠ˜å  | âŒ å±•å¼€ |
| é•¿å†…å®¹ | æ™ºèƒ½æˆªæ–­ | è™šæ‹Ÿæ»šåŠ¨ | âŒ å®Œå…¨å±•å¼€ |

### 6.2 å»ºè®®çš„æ”¹è¿›

**æ™ºèƒ½æ‘˜è¦**:
```typescript
function summarizeToolCall(toolCall: ToolCall): string {
  switch (toolCall.name) {
    case 'edit_file':
      const lines = (toolCall.arguments.old_string as string)?.split('\n').length;
      return `Editing ${toolCall.arguments.file_path} (replacing ~${lines} lines)`;
    case 'bash':
      return `Running: ${(toolCall.arguments.command as string)?.slice(0, 50)}...`;
    case 'read_file':
      return `Reading ${toolCall.arguments.file_path}`;
    case 'write_file':
      return `Creating ${toolCall.arguments.file_path}`;
  }
}
```

**Diff è§†å›¾**:
```typescript
// ä½¿ç”¨ diff åº“ç”Ÿæˆå¯¹æ¯”
import { diffLines } from 'diff';

const DiffView = ({ oldText, newText }) => {
  const changes = diffLines(oldText, newText);
  return (
    <pre>
      {changes.map(change => (
        <span className={
          change.added ? 'bg-green-500/20' :
          change.removed ? 'bg-red-500/20' : ''
        }>
          {change.added ? '+' : change.removed ? '-' : ' '}
          {change.value}
        </span>
      ))}
    </pre>
  );
};
```

---

## ä¸ƒã€å·²çŸ¥é—®é¢˜ä¸ä¼˜åŒ–æ–¹æ¡ˆ

### 7.1 é—®é¢˜æ¸…å•

| ä¼˜å…ˆçº§ | é—®é¢˜ | å½±å“ | çŠ¶æ€ |
|--------|------|------|------|
| ğŸ”´ P0 | Message ID å‰åç«¯æ ¼å¼ä¸ä¸€è‡´ | åŒæ­¥å†²çª | å¾…ä¿®å¤ |
| ğŸ”´ P0 | toolCallId æ¥è‡ªå¤šä¸ªæ¥æº | å·¥å…·ç»“æœä¸¢å¤± | å¾…ä¿®å¤ |
| ğŸ”´ P0 | MCPClient è¿”å›ç©º toolCallId | MCP å·¥å…·æ— æ³•ä½¿ç”¨ | å¾…ä¿®å¤ |
| ğŸŸ¡ P1 | edit_file å‚æ•°å®Œæ•´å±•ç¤º | ç”¨æˆ·ä½“éªŒå·® | å¾…ä¼˜åŒ– |
| ğŸŸ¡ P1 | buildModelMessages å†å²æ ¼å¼åŒ– | Token æµªè´¹ | å¾…ä¼˜åŒ– |
| ğŸŸ¢ P2 | å·¥å…·è°ƒç”¨é»˜è®¤å±•å¼€ | ä¿¡æ¯å™ªéŸ³ | å¾…ä¼˜åŒ– |

### 7.2 ä¼˜åŒ–æ–¹æ¡ˆ

#### æ–¹æ¡ˆ 1: ç»Ÿä¸€ ID ç”Ÿæˆ (P0)

```typescript
// æ–°å»º src/shared/utils/id.ts
import { v4 as uuidv4 } from 'uuid';

export function generateMessageId(): string {
  return uuidv4();  // ä¾‹: "550e8400-e29b-41d4-a716-446655440000"
}

export function generateToolCallId(): string {
  return `tool-${uuidv4()}`;  // ä¾‹: "tool-550e8400-e29b-41d4-a716-446655440000"
}
```

**ä¿®æ”¹ç‚¹**:
1. `useAgent.ts` - ä½¿ç”¨ `generateMessageId()`
2. `AgentLoop.ts` - ä½¿ç”¨ `generateMessageId()`
3. `AgentLoop.ts` æ–‡æœ¬è§£æå›é€€ - ä½¿ç”¨ `generateToolCallId()`
4. `MCPClient.ts` - æ¥æ”¶å¹¶ä¼ é€’ `toolCallId` å‚æ•°

#### æ–¹æ¡ˆ 2: å·¥å…·è°ƒç”¨æ™ºèƒ½æ‘˜è¦ (P1)

**ä¿®æ”¹æ–‡ä»¶**: `MessageBubble.tsx`

```typescript
// ToolCallDisplay ç»„ä»¶ä¿®æ”¹

// 1. é»˜è®¤æŠ˜å 
const [expanded, setExpanded] = useState(false);

// 2. æ‘˜è¦æ˜¾ç¤º
<span className="text-sm text-zinc-300">
  {summarizeToolCall(toolCall)}
</span>

// 3. edit_file ä¸“å± Diff è§†å›¾
{expanded && toolCall.name === 'edit_file' && (
  <DiffView
    oldText={toolCall.arguments.old_string}
    newText={toolCall.arguments.new_string}
  />
)}
```

#### æ–¹æ¡ˆ 3: å†å²æ¶ˆæ¯ä¼˜åŒ– (P1)

**ä¿®æ”¹æ–‡ä»¶**: `AgentLoop.ts`

```typescript
// buildModelMessages() ä¸­

if (message.role === 'assistant' && message.toolCalls) {
  // ä¼˜åŒ–: åªè®°å½•å·¥å…·åå’Œç®€çŸ­æè¿°ï¼Œä¸è®°å½•å®Œæ•´å‚æ•°
  const toolCallsStr = message.toolCalls
    .map(tc => this.formatToolCallForHistory(tc))
    .join('\n');
  modelMessages.push({
    role: 'assistant',
    content: toolCallsStr || message.content,
  });
}

private formatToolCallForHistory(tc: ToolCall): string {
  switch (tc.name) {
    case 'edit_file':
      return `Edited ${tc.arguments.file_path}`;
    case 'bash':
      return `Ran: ${(tc.arguments.command as string)?.slice(0, 100)}`;
    case 'read_file':
      return `Read ${tc.arguments.file_path}`;
    case 'write_file':
      return `Created ${tc.arguments.file_path}`;
    default:
      return `Called ${tc.name}`;
  }
}
```

---

## å…«ã€æ•°æ®å­˜å‚¨æ¶æ„

### 8.1 æœ¬åœ°å­˜å‚¨ (SQLite)

**ä½ç½®**: `~/.code-agent/data.db`

```sql
-- sessions è¡¨
CREATE TABLE sessions (
  id TEXT PRIMARY KEY,
  title TEXT,
  generation_id TEXT NOT NULL,
  working_directory TEXT,
  created_at INTEGER,
  updated_at INTEGER
);

-- messages è¡¨
CREATE TABLE messages (
  id TEXT PRIMARY KEY,
  session_id TEXT NOT NULL,
  role TEXT NOT NULL,
  content TEXT NOT NULL,
  tool_calls TEXT,     -- JSON
  tool_results TEXT,   -- JSON
  timestamp INTEGER,
  FOREIGN KEY (session_id) REFERENCES sessions(id)
);
```

### 8.2 äº‘ç«¯å­˜å‚¨ (Supabase)

**è¡¨ç»“æ„**:
| è¡¨å | ç”¨é€” | åŒæ­¥ç­–ç•¥ |
|------|------|----------|
| `profiles` | ç”¨æˆ·èµ„æ–™ | å•å‘äº‘ç«¯ |
| `devices` | è®¾å¤‡ç®¡ç† | åŒå‘ |
| `sessions` | ä¼šè¯è®°å½• | å¢é‡åŒæ­¥ |
| `messages` | å¯¹è¯æ¶ˆæ¯ | å¢é‡åŒæ­¥ |
| `user_preferences` | ç”¨æˆ·åå¥½ | Last-Write-Wins |
| `vector_documents` | å‘é‡å­˜å‚¨ | ä»…ä¸Šä¼  |

### 8.3 å‘é‡æ•°æ®åº“

**æ‰©å±•**: pgvector (Supabase åŸç”Ÿæ”¯æŒ)
**ç»´åº¦**: 1024 (DeepSeek embedding)
**ç´¢å¼•**: HNSW (cosine è·ç¦»)
**ç”¨é€”**: è¯­ä¹‰æœç´¢ã€é•¿æœŸè®°å¿†ã€RAG ä¸Šä¸‹æ–‡

---

## ä¹ã€æ–‡ä»¶ç›®å½•ç»“æ„

```
code-agent/
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ PRD.md                      # äº§å“éœ€æ±‚æ–‡æ¡£
â”‚   â””â”€â”€ ARCHITECTURE.md             # æ¶æ„è®¾è®¡æ–‡æ¡£ (æœ¬æ–‡æ¡£)
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main/                       # Electron ä¸»è¿›ç¨‹
â”‚   â”‚   â”œâ”€â”€ index.ts               # å…¥å£
â”‚   â”‚   â”œâ”€â”€ agent/
â”‚   â”‚   â”‚   â”œâ”€â”€ AgentLoop.ts       # Agent äº‹ä»¶å¾ªç¯ (530 è¡Œ)
â”‚   â”‚   â”‚   â”œâ”€â”€ AgentOrchestrator.ts # ç¼–æ’å™¨ (235 è¡Œ)
â”‚   â”‚   â”‚   â””â”€â”€ GUIAgent.ts        # GUI ä»£ç†
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ generation/
â”‚   â”‚   â”‚   â””â”€â”€ GenerationManager.ts # ä»£é™…ç®¡ç† (847 è¡Œ)
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ model/
â”‚   â”‚   â”‚   â””â”€â”€ ModelRouter.ts     # æ¨¡å‹è·¯ç”± (1425 è¡Œ)
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ tools/
â”‚   â”‚   â”‚   â”œâ”€â”€ ToolRegistry.ts    # å·¥å…·æ³¨å†Œè¡¨ (172 è¡Œ)
â”‚   â”‚   â”‚   â”œâ”€â”€ ToolExecutor.ts    # å·¥å…·æ‰§è¡Œå™¨ (200 è¡Œ)
â”‚   â”‚   â”‚   â”œâ”€â”€ gen1/              # bash, readFile, writeFile, editFile
â”‚   â”‚   â”‚   â”œâ”€â”€ gen2/              # glob, grep, listDirectory
â”‚   â”‚   â”‚   â”œâ”€â”€ gen3/              # task, todoWrite, askUserQuestion
â”‚   â”‚   â”‚   â””â”€â”€ gen4/              # skill, webFetch
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”œâ”€â”€ AuthService.ts     # è®¤è¯æœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ SyncService.ts     # äº‘ç«¯åŒæ­¥
â”‚   â”‚   â”‚   â”œâ”€â”€ DatabaseService.ts # æœ¬åœ° SQLite
â”‚   â”‚   â”‚   â””â”€â”€ SecureStorage.ts   # å®‰å…¨å­˜å‚¨
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ memory/
â”‚   â”‚   â”‚   â”œâ”€â”€ MemoryService.ts   # è®°å¿†æœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ EmbeddingService.ts # å‘é‡åµŒå…¥
â”‚   â”‚   â”‚   â””â”€â”€ VectorStore.ts     # å‘é‡å­˜å‚¨
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ mcp/
â”‚   â”‚       â”œâ”€â”€ MCPClient.ts       # MCP å®¢æˆ·ç«¯
â”‚   â”‚       â””â”€â”€ LogCollector.ts    # æ—¥å¿—æ”¶é›†
â”‚   â”‚
â”‚   â”œâ”€â”€ renderer/                   # React æ¸²æŸ“è¿›ç¨‹
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ ChatView.tsx       # èŠå¤©è§†å›¾
â”‚   â”‚   â”‚   â”œâ”€â”€ ChatInput.tsx      # è¾“å…¥æ¡†
â”‚   â”‚   â”‚   â”œâ”€â”€ MessageBubble.tsx  # æ¶ˆæ¯æ°”æ³¡ (442 è¡Œ)
â”‚   â”‚   â”‚   â””â”€â”€ Sidebar.tsx        # ä¾§è¾¹æ 
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”‚   â”œâ”€â”€ useAgent.ts        # Agent Hook
â”‚   â”‚   â”‚   â””â”€â”€ useGeneration.ts   # ä»£é™… Hook
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ stores/
â”‚   â”‚       â”œâ”€â”€ sessionStore.ts    # ä¼šè¯çŠ¶æ€
â”‚   â”‚       â”œâ”€â”€ appStore.ts        # å…¨å±€çŠ¶æ€
â”‚   â”‚       â””â”€â”€ authStore.ts       # è®¤è¯çŠ¶æ€
â”‚   â”‚
â”‚   â”œâ”€â”€ shared/                     # å…±äº«ç±»å‹
â”‚   â”‚   â”œâ”€â”€ types.ts               # æ ¸å¿ƒç±»å‹
â”‚   â”‚   â””â”€â”€ ipc.ts                 # IPC å®šä¹‰
â”‚   â”‚
â”‚   â””â”€â”€ preload/
â”‚       â””â”€â”€ index.ts               # Preload è„šæœ¬
â”‚
â”œâ”€â”€ supabase/
â”‚   â””â”€â”€ migrations/                # æ•°æ®åº“è¿ç§»
â”‚
â”œâ”€â”€ CLAUDE.md                      # é¡¹ç›®è¯´æ˜
â””â”€â”€ package.json
```

---

## åã€é™„å½•

### 10.1 æ ¸å¿ƒç±»å‹å®šä¹‰

```typescript
// src/shared/types.ts

interface Message {
  id: string;
  role: 'user' | 'assistant' | 'system' | 'tool';
  content: string;
  timestamp: number;
  toolCalls?: ToolCall[];
  toolResults?: ToolResult[];
}

interface ToolCall {
  id: string;               // å…³é”®: æ¨¡å‹ç”Ÿæˆæˆ–æœ¬åœ°ç”Ÿæˆ
  name: string;
  arguments: Record<string, unknown>;
  result?: ToolResult;      // å‰ç«¯é™„åŠ 
}

interface ToolResult {
  toolCallId: string;       // å…³é”®: å¿…é¡»ä¸ ToolCall.id ä¸€è‡´
  success: boolean;
  output?: string;
  error?: string;
  duration?: number;
}

type AgentEvent =
  | { type: 'message'; data: Message }
  | { type: 'tool_call_start'; data: ToolCall }
  | { type: 'tool_call_end'; data: ToolResult }
  | { type: 'permission_request'; data: PermissionRequest }
  | { type: 'error'; data: { message: string } }
  | { type: 'stream_chunk'; data: { content: string } }
  | { type: 'notification'; data: { message: string } }
  | { type: 'agent_complete'; data: null };
```

### 10.2 å‚è€ƒèµ„æ–™

- [Claude Code å®˜æ–¹æ–‡æ¡£](https://docs.anthropic.com/claude-code)
- [Electron å®˜æ–¹æ–‡æ¡£](https://www.electronjs.org/docs)
- [DeepSeek API æ–‡æ¡£](https://platform.deepseek.com/docs)
- [Supabase æ–‡æ¡£](https://supabase.com/docs)
- [pgvector æ–‡æ¡£](https://github.com/pgvector/pgvector)

---

## åä¸€ã€äº‘ç«¯ä¸æœ¬åœ°ååŒæ¶æ„ (Gen 5-8 æ¼”è¿›)

### 11.1 æ¶æ„æ€»è§ˆ

äº‘ç«¯ä¸æœ¬åœ°ååŒæ˜¯ Gen 5-8 èƒ½åŠ›æ¼”è¿›çš„æ ¸å¿ƒåŸºç¡€è®¾æ–½ã€‚é€šè¿‡åˆç†çš„ä»»åŠ¡åˆ†å·¥ï¼Œå®ç°ï¼š
- **æœ¬åœ°**ï¼šè´Ÿè´£"æ‰‹è„š"ï¼ˆæ–‡ä»¶æ“ä½œã€ç»ˆç«¯æ‰§è¡Œã€UI äº¤äº’ï¼‰
- **äº‘ç«¯**ï¼šè´Ÿè´£"å¤§è„‘"ï¼ˆå¤æ‚æ¨ç†ã€å¤šä»£ç†è°ƒåº¦ã€è·¨è®¾å¤‡è®°å¿†ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Cloud-Local Hybrid Architecture                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                     Local Client (Electron App)                          â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚   â”‚
â”‚   â”‚  â”‚  Local Agent   â”‚ â”‚  Task Router   â”‚ â”‚  Sync Engine   â”‚               â”‚   â”‚
â”‚   â”‚  â”‚    Loop        â”‚ â”‚                â”‚ â”‚                â”‚               â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚   â”‚
â”‚   â”‚          â”‚                  â”‚                  â”‚                         â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚   â”‚
â”‚   â”‚  â”‚                   Local Executor                      â”‚               â”‚   â”‚
â”‚   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚               â”‚   â”‚
â”‚   â”‚  â”‚  â”‚  File   â”‚ â”‚  Shell  â”‚ â”‚   Git   â”‚ â”‚Computer â”‚    â”‚               â”‚   â”‚
â”‚   â”‚  â”‚  â”‚  Ops    â”‚ â”‚  Exec   â”‚ â”‚   Ops   â”‚ â”‚  Use    â”‚    â”‚               â”‚   â”‚
â”‚   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚               â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                             â”‚
â”‚                          WebSocket â”‚ + REST API                                  â”‚
â”‚                                    â”‚                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                        Supabase Cloud Platform                           â”‚   â”‚
â”‚   â”‚                                                                          â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚   â”‚  â”‚                     Edge Functions Layer                         â”‚    â”‚   â”‚
â”‚   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚   â”‚
â”‚   â”‚  â”‚  â”‚   Task     â”‚ â”‚  Agent     â”‚ â”‚  Workflow  â”‚ â”‚  Strategy  â”‚   â”‚    â”‚   â”‚
â”‚   â”‚  â”‚  â”‚  Router    â”‚ â”‚ Scheduler  â”‚ â”‚  Engine    â”‚ â”‚  Optimizer â”‚   â”‚    â”‚   â”‚
â”‚   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚   â”‚                                                                          â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚   â”‚  â”‚                     Data Layer                                   â”‚    â”‚   â”‚
â”‚   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚   â”‚
â”‚   â”‚  â”‚  â”‚   Task     â”‚ â”‚   Agent    â”‚ â”‚  Vector    â”‚ â”‚  Strategy  â”‚   â”‚    â”‚   â”‚
â”‚   â”‚  â”‚  â”‚   Queue    â”‚ â”‚   State    â”‚ â”‚   Store    â”‚ â”‚   Cache    â”‚   â”‚    â”‚   â”‚
â”‚   â”‚  â”‚  â”‚ (Postgres) â”‚ â”‚ (Postgres) â”‚ â”‚ (pgvector) â”‚ â”‚  (Redis)   â”‚   â”‚    â”‚   â”‚
â”‚   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚   â”‚                                                                          â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚   â”‚  â”‚                     AI Services Layer                            â”‚    â”‚   â”‚
â”‚   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚   â”‚
â”‚   â”‚  â”‚  â”‚              Claude Agent SDK (Anthropic)                   â”‚ â”‚    â”‚   â”‚
â”‚   â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚ â”‚    â”‚   â”‚
â”‚   â”‚  â”‚  â”‚  â”‚ Planner â”‚ â”‚  Coder  â”‚ â”‚Reviewer â”‚ â”‚Researcherâ”‚          â”‚ â”‚    â”‚   â”‚
â”‚   â”‚  â”‚  â”‚  â”‚  Agent  â”‚ â”‚  Agent  â”‚ â”‚  Agent  â”‚ â”‚  Agent  â”‚          â”‚ â”‚    â”‚   â”‚
â”‚   â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ â”‚    â”‚   â”‚
â”‚   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.2 ä»»åŠ¡åˆ†ç±»ä¸è·¯ç”±ç­–ç•¥

#### 11.2.1 ä»»åŠ¡åˆ†ç±»çŸ©é˜µ

| ä»»åŠ¡ç±»å‹ | æ‰§è¡Œä½ç½® | åŸå›  | ç¤ºä¾‹ |
|----------|----------|------|------|
| **æ–‡ä»¶ç³»ç»Ÿæ“ä½œ** | ğŸ  æœ¬åœ° | éœ€è¦æœ¬åœ°æ–‡ä»¶è®¿é—®æƒé™ | read_file, write_file, edit_file |
| **ç»ˆç«¯å‘½ä»¤æ‰§è¡Œ** | ğŸ  æœ¬åœ° | éœ€è¦æœ¬åœ°ç¯å¢ƒå’Œå·¥å…·é“¾ | bash, npm, git |
| **Computer Use** | ğŸ  æœ¬åœ° | éœ€è¦æœ¬åœ°å±å¹•å’Œè¾“å…¥è®¾å¤‡ | screenshot, click, type |
| **æ•æ„Ÿä»£ç å¤„ç†** | ğŸ  æœ¬åœ° | éšç§å’Œå®‰å…¨è€ƒè™‘ | å«å¯†é’¥/å‡­è¯çš„ä»£ç  |
| **å®æ—¶ UI äº¤äº’** | ğŸ  æœ¬åœ° | éœ€è¦å³æ—¶å“åº” | ask_user_question |
| **ä»£ç å®¡æŸ¥åˆ†æ** | â˜ï¸ äº‘ç«¯ | çº¯æ¨ç†ä»»åŠ¡ï¼Œæ— æœ¬åœ°ä¾èµ– | review_code |
| **æ–‡æ¡£ç”Ÿæˆ** | â˜ï¸ äº‘ç«¯ | å¯ç¦»çº¿å®Œæˆï¼Œç»“æœåŒæ­¥ | generate_docs |
| **å¤šæ–‡ä»¶é‡æ„è§„åˆ’** | â˜ï¸ äº‘ç«¯ | å¤æ‚æ¨ç†ï¼Œäº‘ç«¯ç®—åŠ›æ›´å¼º | plan_refactor |
| **è·¨é¡¹ç›®çŸ¥è¯†æ£€ç´¢** | â˜ï¸ äº‘ç«¯ | äº‘ç«¯å‘é‡åº“ç»Ÿä¸€ç®¡ç† | semantic_search |
| **å¤šä»£ç†ååŒ** | â˜ï¸ äº‘ç«¯ | äº‘ç«¯è°ƒåº¦å¤šä¸ª Agent æ›´é«˜æ•ˆ | multi_agent_task |
| **å¤§å‹é‡æ„æ‰§è¡Œ** | ğŸ”„ æ··åˆ | äº‘ç«¯è§„åˆ’ + æœ¬åœ°æ‰§è¡Œ | refactor_module |

#### 11.2.2 ä»»åŠ¡è·¯ç”±å™¨è®¾è®¡

```typescript
// src/main/cloud/TaskRouter.ts

export type TaskTarget = 'local' | 'cloud' | 'hybrid';

export interface RoutingRule {
  pattern: RegExp | string[];
  target: TaskTarget;
  priority: number;
  condition?: (task: Task) => boolean;
}

export class TaskRouter {
  private rules: RoutingRule[] = [
    // å¿…é¡»æœ¬åœ°æ‰§è¡Œ
    {
      pattern: ['bash', 'read_file', 'write_file', 'edit_file', 'glob', 'grep'],
      target: 'local',
      priority: 100,
    },
    {
      pattern: ['screenshot', 'computer_use', 'click', 'type', 'scroll'],
      target: 'local',
      priority: 100,
    },
    {
      pattern: ['ask_user_question'],
      target: 'local',
      priority: 100,
    },

    // å¿…é¡»äº‘ç«¯æ‰§è¡Œ
    {
      pattern: ['cross_project_search', 'semantic_search'],
      target: 'cloud',
      priority: 90,
    },
    {
      pattern: ['spawn_multi_agent', 'agent_orchestrate'],
      target: 'cloud',
      priority: 90,
    },

    // æ··åˆæ¨¡å¼ï¼šæ ¹æ®ä»»åŠ¡å¤æ‚åº¦åˆ¤æ–­
    {
      pattern: ['refactor', 'implement_feature'],
      target: 'hybrid',
      priority: 80,
      condition: (task) => this.estimateComplexity(task) > 5,
    },

    // å¯äº‘ç«¯åŠ é€Ÿçš„çº¯æ¨ç†ä»»åŠ¡
    {
      pattern: ['code_review', 'generate_docs', 'explain_code'],
      target: 'cloud',
      priority: 70,
      condition: (task) => this.isCloudAvailable(),
    },

    // é»˜è®¤æœ¬åœ°
    {
      pattern: /.*/,
      target: 'local',
      priority: 0,
    },
  ];

  route(task: Task): TaskTarget {
    const sortedRules = [...this.rules].sort((a, b) => b.priority - a.priority);

    for (const rule of sortedRules) {
      if (this.matchRule(task, rule)) {
        if (!rule.condition || rule.condition(task)) {
          return rule.target;
        }
      }
    }

    return 'local';
  }

  private matchRule(task: Task, rule: RoutingRule): boolean {
    if (Array.isArray(rule.pattern)) {
      return rule.pattern.includes(task.type);
    }
    return rule.pattern.test(task.type);
  }

  private estimateComplexity(task: Task): number {
    // åŸºäºæ–‡ä»¶æ•°é‡ã€ä»£ç è¡Œæ•°ã€ä¾èµ–å…³ç³»ç­‰ä¼°ç®—å¤æ‚åº¦
    let score = 0;
    if (task.metadata?.fileCount) score += task.metadata.fileCount;
    if (task.metadata?.estimatedChanges) score += task.metadata.estimatedChanges / 100;
    return score;
  }

  private isCloudAvailable(): boolean {
    return CloudClient.getInstance().isConnected();
  }
}
```

### 11.3 äº‘ç«¯ä»»åŠ¡é˜Ÿåˆ—ç³»ç»Ÿ

#### 11.3.1 æ•°æ®åº“è®¾è®¡

```sql
-- äº‘ç«¯ä»»åŠ¡é˜Ÿåˆ—è¡¨
CREATE TABLE cloud_tasks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  device_id UUID REFERENCES devices(id),
  session_id UUID REFERENCES sessions(id),

  -- ä»»åŠ¡å®šä¹‰
  type TEXT NOT NULL,                    -- 'code_review', 'refactor_plan', 'multi_agent'
  name TEXT NOT NULL,                    -- äººç±»å¯è¯»çš„ä»»åŠ¡åç§°
  description TEXT,                      -- ä»»åŠ¡æè¿°

  -- çŠ¶æ€ç®¡ç†
  status TEXT NOT NULL DEFAULT 'pending'
    CHECK (status IN ('pending', 'queued', 'running', 'paused', 'completed', 'failed', 'cancelled')),
  priority INTEGER DEFAULT 5 CHECK (priority BETWEEN 1 AND 10),

  -- è¾“å…¥è¾“å‡º
  input JSONB NOT NULL,                  -- ä»»åŠ¡è¾“å…¥å‚æ•°
  result JSONB,                          -- æ‰§è¡Œç»“æœ
  error JSONB,                           -- é”™è¯¯ä¿¡æ¯

  -- æ‰§è¡Œå…ƒæ•°æ®
  agent_type TEXT,                       -- ä½¿ç”¨çš„ Agent ç±»å‹
  agent_config JSONB,                    -- Agent é…ç½®
  tokens_used INTEGER DEFAULT 0,
  estimated_tokens INTEGER,

  -- è¿›åº¦è¿½è¸ª
  progress INTEGER DEFAULT 0 CHECK (progress BETWEEN 0 AND 100),
  current_step TEXT,
  total_steps INTEGER,
  completed_steps INTEGER DEFAULT 0,

  -- æ—¶é—´æˆ³
  created_at TIMESTAMPTZ DEFAULT now(),
  queued_at TIMESTAMPTZ,
  started_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,

  -- è¶…æ—¶å’Œé‡è¯•
  timeout_seconds INTEGER DEFAULT 3600,  -- é»˜è®¤ 1 å°æ—¶è¶…æ—¶
  retry_count INTEGER DEFAULT 0,
  max_retries INTEGER DEFAULT 3,

  -- ä¾èµ–å…³ç³»
  parent_task_id UUID REFERENCES cloud_tasks(id),
  depends_on UUID[] DEFAULT '{}'::UUID[],

  -- é€šçŸ¥è®¾ç½®
  notify_on_complete BOOLEAN DEFAULT true,
  notify_channels TEXT[] DEFAULT '{}'::TEXT[]  -- 'push', 'email', 'webhook'
);

-- ä»»åŠ¡æ—¥å¿—è¡¨
CREATE TABLE task_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  task_id UUID NOT NULL REFERENCES cloud_tasks(id) ON DELETE CASCADE,

  level TEXT NOT NULL CHECK (level IN ('debug', 'info', 'warn', 'error')),
  message TEXT NOT NULL,
  metadata JSONB,

  agent_id TEXT,                         -- äº§ç”Ÿæ—¥å¿—çš„ Agent
  step_index INTEGER,

  created_at TIMESTAMPTZ DEFAULT now()
);

-- ä»»åŠ¡æ‰§è¡Œæ­¥éª¤è¡¨
CREATE TABLE task_steps (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  task_id UUID NOT NULL REFERENCES cloud_tasks(id) ON DELETE CASCADE,

  step_index INTEGER NOT NULL,
  name TEXT NOT NULL,
  description TEXT,

  status TEXT NOT NULL DEFAULT 'pending'
    CHECK (status IN ('pending', 'running', 'completed', 'failed', 'skipped')),

  input JSONB,
  output JSONB,
  error JSONB,

  started_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,
  duration_ms INTEGER,

  -- æœ¬åœ°æ‰§è¡Œæ ‡è®°
  requires_local_execution BOOLEAN DEFAULT false,
  local_execution_request JSONB,         -- éœ€è¦æœ¬åœ°æ‰§è¡Œçš„è¯·æ±‚
  local_execution_result JSONB,          -- æœ¬åœ°æ‰§è¡Œçš„ç»“æœ

  UNIQUE (task_id, step_index)
);

-- ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_cloud_tasks_user_status ON cloud_tasks(user_id, status);
CREATE INDEX idx_cloud_tasks_created_at ON cloud_tasks(created_at DESC);
CREATE INDEX idx_cloud_tasks_priority_status ON cloud_tasks(priority DESC, status)
  WHERE status IN ('pending', 'queued');
CREATE INDEX idx_task_logs_task_id ON task_logs(task_id, created_at DESC);
CREATE INDEX idx_task_steps_task_id ON task_steps(task_id, step_index);

-- å®æ—¶è®¢é˜…æ”¯æŒ
ALTER PUBLICATION supabase_realtime ADD TABLE cloud_tasks;
ALTER PUBLICATION supabase_realtime ADD TABLE task_steps;
```

#### 11.3.2 ä»»åŠ¡é˜Ÿåˆ—æœåŠ¡

```typescript
// src/main/cloud/CloudTaskService.ts

import { SupabaseClient } from '@supabase/supabase-js';

export interface CloudTask {
  id: string;
  type: string;
  name: string;
  status: TaskStatus;
  input: Record<string, unknown>;
  result?: Record<string, unknown>;
  progress: number;
  currentStep?: string;
}

export type TaskStatus =
  | 'pending'
  | 'queued'
  | 'running'
  | 'paused'
  | 'completed'
  | 'failed'
  | 'cancelled';

export class CloudTaskService {
  private supabase: SupabaseClient;
  private subscriptions: Map<string, RealtimeChannel> = new Map();

  constructor(supabase: SupabaseClient) {
    this.supabase = supabase;
  }

  /**
   * æäº¤äº‘ç«¯ä»»åŠ¡
   */
  async submitTask(params: {
    type: string;
    name: string;
    description?: string;
    input: Record<string, unknown>;
    priority?: number;
    notifyOnComplete?: boolean;
    timeoutSeconds?: number;
  }): Promise<string> {
    const { data, error } = await this.supabase
      .from('cloud_tasks')
      .insert({
        type: params.type,
        name: params.name,
        description: params.description,
        input: params.input,
        priority: params.priority ?? 5,
        notify_on_complete: params.notifyOnComplete ?? true,
        timeout_seconds: params.timeoutSeconds ?? 3600,
        device_id: await this.getDeviceId(),
      })
      .select('id')
      .single();

    if (error) throw error;

    // è§¦å‘äº‘ç«¯ä»»åŠ¡è°ƒåº¦
    await this.triggerScheduler(data.id);

    return data.id;
  }

  /**
   * æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
   */
  async getTaskStatus(taskId: string): Promise<CloudTask> {
    const { data, error } = await this.supabase
      .from('cloud_tasks')
      .select('*')
      .eq('id', taskId)
      .single();

    if (error) throw error;
    return this.mapToCloudTask(data);
  }

  /**
   * è·å–ä»»åŠ¡åˆ—è¡¨
   */
  async listTasks(options?: {
    status?: TaskStatus[];
    limit?: number;
    offset?: number;
  }): Promise<CloudTask[]> {
    let query = this.supabase
      .from('cloud_tasks')
      .select('*')
      .order('created_at', { ascending: false });

    if (options?.status?.length) {
      query = query.in('status', options.status);
    }
    if (options?.limit) {
      query = query.limit(options.limit);
    }
    if (options?.offset) {
      query = query.range(options.offset, options.offset + (options.limit ?? 10) - 1);
    }

    const { data, error } = await query;
    if (error) throw error;

    return data.map(this.mapToCloudTask);
  }

  /**
   * å–æ¶ˆä»»åŠ¡
   */
  async cancelTask(taskId: string): Promise<void> {
    const { error } = await this.supabase
      .from('cloud_tasks')
      .update({
        status: 'cancelled',
        completed_at: new Date().toISOString()
      })
      .eq('id', taskId)
      .in('status', ['pending', 'queued', 'running', 'paused']);

    if (error) throw error;
  }

  /**
   * è®¢é˜…ä»»åŠ¡çŠ¶æ€æ›´æ–°
   */
  subscribeToTask(
    taskId: string,
    callback: (task: CloudTask) => void
  ): () => void {
    const channel = this.supabase
      .channel(`task:${taskId}`)
      .on(
        'postgres_changes',
        {
          event: 'UPDATE',
          schema: 'public',
          table: 'cloud_tasks',
          filter: `id=eq.${taskId}`,
        },
        (payload) => {
          callback(this.mapToCloudTask(payload.new));
        }
      )
      .subscribe();

    this.subscriptions.set(taskId, channel);

    return () => {
      channel.unsubscribe();
      this.subscriptions.delete(taskId);
    };
  }

  /**
   * è®¢é˜…æ‰€æœ‰ä»»åŠ¡æ›´æ–°
   */
  subscribeToAllTasks(callback: (task: CloudTask) => void): () => void {
    const channel = this.supabase
      .channel('all-tasks')
      .on(
        'postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: 'cloud_tasks',
        },
        (payload) => {
          if (payload.new) {
            callback(this.mapToCloudTask(payload.new));
          }
        }
      )
      .subscribe();

    return () => channel.unsubscribe();
  }

  /**
   * è·å–ä»»åŠ¡æ—¥å¿—
   */
  async getTaskLogs(taskId: string, options?: {
    level?: string[];
    limit?: number;
  }): Promise<TaskLog[]> {
    let query = this.supabase
      .from('task_logs')
      .select('*')
      .eq('task_id', taskId)
      .order('created_at', { ascending: true });

    if (options?.level?.length) {
      query = query.in('level', options.level);
    }
    if (options?.limit) {
      query = query.limit(options.limit);
    }

    const { data, error } = await query;
    if (error) throw error;

    return data;
  }

  /**
   * å¤„ç†äº‘ç«¯è¯·æ±‚æœ¬åœ°æ‰§è¡Œ
   */
  async handleLocalExecutionRequest(stepId: string): Promise<void> {
    const { data: step, error } = await this.supabase
      .from('task_steps')
      .select('*')
      .eq('id', stepId)
      .single();

    if (error) throw error;
    if (!step.requires_local_execution) return;

    // æ‰§è¡Œæœ¬åœ°ä»»åŠ¡
    const localResult = await this.executeLocally(step.local_execution_request);

    // ä¸ŠæŠ¥ç»“æœ
    await this.supabase
      .from('task_steps')
      .update({
        local_execution_result: localResult,
        status: localResult.success ? 'completed' : 'failed',
        completed_at: new Date().toISOString(),
      })
      .eq('id', stepId);
  }

  private async executeLocally(request: LocalExecutionRequest): Promise<LocalExecutionResult> {
    // è°ƒç”¨æœ¬åœ° ToolExecutor
    const toolExecutor = ToolExecutor.getInstance();
    return await toolExecutor.execute(
      request.tool,
      request.arguments,
      request.context
    );
  }

  private async triggerScheduler(taskId: string): Promise<void> {
    await this.supabase.functions.invoke('task-scheduler', {
      body: { taskId }
    });
  }

  private async getDeviceId(): Promise<string> {
    // ä»æœ¬åœ°é…ç½®è·å–è®¾å¤‡ ID
    return ConfigService.getInstance().getDeviceId();
  }

  private mapToCloudTask(data: any): CloudTask {
    return {
      id: data.id,
      type: data.type,
      name: data.name,
      status: data.status,
      input: data.input,
      result: data.result,
      progress: data.progress,
      currentStep: data.current_step,
    };
  }
}
```

### 11.4 æ··åˆæ‰§è¡Œæ¨¡å¼ (Hybrid Mode)

#### 11.4.1 æ‰§è¡Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Hybrid Task Execution Flow                                   â”‚
â”‚                     (äº‘ç«¯è§„åˆ’ + æœ¬åœ°æ‰§è¡Œ + äº‘ç«¯å®¡æŸ¥)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·è¯·æ±‚: "é‡æ„ auth æ¨¡å—ï¼Œæå–å…¬å…±é€»è¾‘"
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 1: äº‘ç«¯è§„åˆ’ (Cloud Planning)                                               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ Planner Agent (Claude)                                                   â”‚   â”‚
â”‚   â”‚                                                                          â”‚   â”‚
â”‚   â”‚ 1. åˆ†æä»£ç ç»“æ„ (é€šè¿‡å·²ä¸Šä¼ çš„ä»£ç ç´¢å¼•)                                    â”‚   â”‚
â”‚   â”‚ 2. è¯†åˆ«é‡æ„ç‚¹å’Œä¾èµ–å…³ç³»                                                   â”‚   â”‚
â”‚   â”‚ 3. ç”Ÿæˆé‡æ„è®¡åˆ’:                                                         â”‚   â”‚
â”‚   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚   â”‚    â”‚ Step 1: åˆ›å»º src/utils/authHelpers.ts [LOCAL: write_file]       â”‚  â”‚   â”‚
â”‚   â”‚    â”‚ Step 2: æå– validateToken å‡½æ•° [LOCAL: edit_file]              â”‚  â”‚   â”‚
â”‚   â”‚    â”‚ Step 3: æå– refreshSession å‡½æ•° [LOCAL: edit_file]             â”‚  â”‚   â”‚
â”‚   â”‚    â”‚ Step 4: æ›´æ–° AuthService å¯¼å…¥ [LOCAL: edit_file]                â”‚  â”‚   â”‚
â”‚   â”‚    â”‚ Step 5: è¿è¡Œæµ‹è¯•éªŒè¯ [LOCAL: bash npm test]                     â”‚  â”‚   â”‚
â”‚   â”‚    â”‚ Step 6: ä»£ç å®¡æŸ¥ [CLOUD: review]                                â”‚  â”‚   â”‚
â”‚   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚ è®¡åˆ’ä¸‹å‘
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 2: æœ¬åœ°æ‰§è¡Œ (Local Execution)                                              â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ Local Agent Loop                                                         â”‚   â”‚
â”‚   â”‚                                                                          â”‚   â”‚
â”‚   â”‚ FOR EACH step WHERE requires_local_execution:                            â”‚   â”‚
â”‚   â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â”‚   â”œâ”€ Step 1: write_file('src/utils/authHelpers.ts', content)            â”‚   â”‚
â”‚   â”‚   â”‚          â†’ ä¸ŠæŠ¥ç»“æœåˆ°äº‘ç«¯                                            â”‚   â”‚
â”‚   â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â”‚   â”œâ”€ Step 2: edit_file('src/services/AuthService.ts', ...)              â”‚   â”‚
â”‚   â”‚   â”‚          â†’ ä¸ŠæŠ¥ç»“æœåˆ°äº‘ç«¯                                            â”‚   â”‚
â”‚   â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â”‚   â”œâ”€ Step 3-4: ç»§ç»­æ‰§è¡Œ edit_file                                       â”‚   â”‚
â”‚   â”‚   â”‚          â†’ ä¸ŠæŠ¥ç»“æœåˆ°äº‘ç«¯                                            â”‚   â”‚
â”‚   â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â”‚   â””â”€ Step 5: bash('npm test')                                           â”‚   â”‚
â”‚   â”‚              â†’ æµ‹è¯•ç»“æœä¸ŠæŠ¥äº‘ç«¯                                          â”‚   â”‚
â”‚   â”‚                                                                          â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚ æ‰§è¡Œç»“æœ
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 3: äº‘ç«¯å®¡æŸ¥ (Cloud Review)                                                 â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ Reviewer Agent (Claude)                                                  â”‚   â”‚
â”‚   â”‚                                                                          â”‚   â”‚
â”‚   â”‚ 1. æ£€æŸ¥ä¿®æ”¹è´¨é‡                                                          â”‚   â”‚
â”‚   â”‚ 2. éªŒè¯æµ‹è¯•é€šè¿‡                                                          â”‚   â”‚
â”‚   â”‚ 3. ç”Ÿæˆå®¡æŸ¥æŠ¥å‘Š:                                                         â”‚   â”‚
â”‚   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚   â”‚    â”‚ âœ… ä»£ç ç»“æ„æ”¹å–„                                                 â”‚  â”‚   â”‚
â”‚   â”‚    â”‚ âœ… å‡½æ•°èŒè´£å•ä¸€                                                 â”‚  â”‚   â”‚
â”‚   â”‚    â”‚ âš ï¸ å»ºè®®: æ·»åŠ  JSDoc æ³¨é‡Š                                        â”‚  â”‚   â”‚
â”‚   â”‚    â”‚ âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡                                                 â”‚  â”‚   â”‚
â”‚   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚   â”‚                                                                          â”‚   â”‚
â”‚   â”‚ 4. æ ‡è®°ä»»åŠ¡å®Œæˆ                                                          â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 4: é€šçŸ¥ç”¨æˆ·                                                                â”‚
â”‚                                                                                  â”‚
â”‚   â€¢ æ¡Œé¢é€šçŸ¥: "é‡æ„ auth æ¨¡å—å®Œæˆ"                                               â”‚
â”‚   â€¢ å¯é€‰: é‚®ä»¶/æ¨é€é€šçŸ¥                                                          â”‚
â”‚   â€¢ æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š                                                                 â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 11.4.2 æ··åˆä»»åŠ¡åè°ƒå™¨

```typescript
// src/main/cloud/HybridTaskCoordinator.ts

export interface HybridTaskPlan {
  taskId: string;
  name: string;
  steps: TaskStep[];
  metadata: {
    estimatedDuration: number;
    localStepsCount: number;
    cloudStepsCount: number;
  };
}

export interface TaskStep {
  index: number;
  name: string;
  description: string;
  executionTarget: 'local' | 'cloud';
  tool?: string;
  arguments?: Record<string, unknown>;
  dependsOn?: number[];  // ä¾èµ–çš„æ­¥éª¤ç´¢å¼•
}

export class HybridTaskCoordinator {
  private cloudService: CloudTaskService;
  private localExecutor: ToolExecutor;
  private eventEmitter: EventEmitter;

  constructor() {
    this.cloudService = CloudTaskService.getInstance();
    this.localExecutor = ToolExecutor.getInstance();
    this.eventEmitter = new EventEmitter();
  }

  /**
   * æ‰§è¡Œæ··åˆä»»åŠ¡
   */
  async executeHybridTask(
    taskType: string,
    input: Record<string, unknown>,
    options?: {
      onProgress?: (progress: TaskProgress) => void;
      onLocalExecution?: (step: TaskStep) => Promise<boolean>;  // è¿”å›æ˜¯å¦ç»§ç»­
    }
  ): Promise<HybridTaskResult> {
    // 1. æäº¤äº‘ç«¯ä»»åŠ¡ï¼Œè·å–æ‰§è¡Œè®¡åˆ’
    const taskId = await this.cloudService.submitTask({
      type: taskType,
      name: input.name as string,
      input,
    });

    // 2. è®¢é˜…ä»»åŠ¡çŠ¶æ€
    const unsubscribe = this.cloudService.subscribeToTask(taskId, async (task) => {
      options?.onProgress?.({
        taskId,
        status: task.status,
        progress: task.progress,
        currentStep: task.currentStep,
      });

      // æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æœ¬åœ°æ‰§è¡Œçš„æ­¥éª¤
      if (task.status === 'running') {
        await this.checkAndExecuteLocalSteps(taskId, options?.onLocalExecution);
      }
    });

    try {
      // 3. ç­‰å¾…ä»»åŠ¡å®Œæˆ
      const result = await this.waitForCompletion(taskId);
      return result;
    } finally {
      unsubscribe();
    }
  }

  /**
   * æ£€æŸ¥å¹¶æ‰§è¡Œéœ€è¦æœ¬åœ°æ‰§è¡Œçš„æ­¥éª¤
   */
  private async checkAndExecuteLocalSteps(
    taskId: string,
    onLocalExecution?: (step: TaskStep) => Promise<boolean>
  ): Promise<void> {
    // è·å–å¾…æ‰§è¡Œçš„æœ¬åœ°æ­¥éª¤
    const { data: steps } = await this.cloudService.supabase
      .from('task_steps')
      .select('*')
      .eq('task_id', taskId)
      .eq('requires_local_execution', true)
      .eq('status', 'pending')
      .is('local_execution_result', null);

    for (const step of steps || []) {
      // è¯¢é—®ç”¨æˆ·æ˜¯å¦ç»§ç»­
      if (onLocalExecution) {
        const shouldContinue = await onLocalExecution(step);
        if (!shouldContinue) {
          await this.cloudService.cancelTask(taskId);
          return;
        }
      }

      // æ‰§è¡Œæœ¬åœ°ä»»åŠ¡
      await this.executeLocalStep(step);
    }
  }

  /**
   * æ‰§è¡Œå•ä¸ªæœ¬åœ°æ­¥éª¤
   */
  private async executeLocalStep(step: any): Promise<void> {
    const request = step.local_execution_request;

    this.eventEmitter.emit('local_step_start', {
      stepId: step.id,
      name: step.name,
      tool: request.tool,
    });

    try {
      const result = await this.localExecutor.execute(
        request.tool,
        request.arguments,
        request.context
      );

      // ä¸ŠæŠ¥ç»“æœ
      await this.cloudService.supabase
        .from('task_steps')
        .update({
          local_execution_result: result,
          status: result.success ? 'completed' : 'failed',
          completed_at: new Date().toISOString(),
        })
        .eq('id', step.id);

      this.eventEmitter.emit('local_step_complete', {
        stepId: step.id,
        success: result.success,
        output: result.output,
      });

    } catch (error) {
      await this.cloudService.supabase
        .from('task_steps')
        .update({
          local_execution_result: { success: false, error: error.message },
          status: 'failed',
          completed_at: new Date().toISOString(),
        })
        .eq('id', step.id);

      this.eventEmitter.emit('local_step_error', {
        stepId: step.id,
        error: error.message,
      });
    }
  }

  /**
   * ç­‰å¾…ä»»åŠ¡å®Œæˆ
   */
  private async waitForCompletion(taskId: string): Promise<HybridTaskResult> {
    return new Promise((resolve, reject) => {
      const checkInterval = setInterval(async () => {
        const task = await this.cloudService.getTaskStatus(taskId);

        if (task.status === 'completed') {
          clearInterval(checkInterval);
          resolve({
            success: true,
            taskId,
            result: task.result,
          });
        } else if (task.status === 'failed' || task.status === 'cancelled') {
          clearInterval(checkInterval);
          reject(new Error(`Task ${task.status}: ${task.result?.error}`));
        }
      }, 2000);

      // è¶…æ—¶å¤„ç† (é»˜è®¤ 1 å°æ—¶)
      setTimeout(() => {
        clearInterval(checkInterval);
        reject(new Error('Task timeout'));
      }, 3600 * 1000);
    });
  }

  on(event: string, listener: (...args: any[]) => void): void {
    this.eventEmitter.on(event, listener);
  }
}
```

### 11.5 å¤šä»£ç†äº‘ç«¯è°ƒåº¦ (Gen 7)

#### 11.5.1 ä¸“ä¸šåŒ– Agent è®¾è®¡ç†å¿µ

**æ ¸å¿ƒæ¦‚å¿µ**: ä¸“ä¸šåŒ– Agent ä¸æ˜¯ä½¿ç”¨ä¸åŒçš„æ¨¡å‹ï¼Œè€Œæ˜¯**åŒä¸€ä¸ªåº•å±‚æ¨¡å‹ + ä¸åŒçš„ System Prompt + ä¸åŒçš„å·¥å…·é›†**ï¼Œè®©æ¨¡å‹æ‰®æ¼”ä¸åŒçš„ä¸“ä¸šè§’è‰²ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ä¸“ä¸šåŒ– Agent æ¶æ„                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚   åº•å±‚æ¨¡å‹ (ç”¨æˆ·é…ç½®çš„æ¨¡å‹ï¼Œå¦‚ DeepSeek / Claude / OpenAI / Groq / æ™ºè°± / é€šä¹‰)    â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                   â”‚
â”‚                           â”‚                                                      â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚           â–¼               â–¼               â–¼               â–¼                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚   â”‚  Planner    â”‚ â”‚   Coder     â”‚ â”‚  Reviewer   â”‚ â”‚ Researcher  â”‚              â”‚
â”‚   â”‚  Agent      â”‚ â”‚   Agent     â”‚ â”‚   Agent     â”‚ â”‚   Agent     â”‚              â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
â”‚   â”‚ System:     â”‚ â”‚ System:     â”‚ â”‚ System:     â”‚ â”‚ System:     â”‚              â”‚
â”‚   â”‚ "ä½ æ˜¯ä»»åŠ¡   â”‚ â”‚ "ä½ æ˜¯ä»£ç    â”‚ â”‚ "ä½ æ˜¯ä»£ç    â”‚ â”‚ "ä½ æ˜¯æŠ€æœ¯   â”‚              â”‚
â”‚   â”‚  è§„åˆ’ä¸“å®¶"  â”‚ â”‚  å®ç°ä¸“å®¶"  â”‚ â”‚  å®¡æŸ¥ä¸“å®¶"  â”‚ â”‚  ç ”ç©¶ä¸“å®¶"  â”‚              â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
â”‚   â”‚ Tools:      â”‚ â”‚ Tools:      â”‚ â”‚ Tools:      â”‚ â”‚ Tools:      â”‚              â”‚
â”‚   â”‚ - analyze   â”‚ â”‚ (æ— å·¥å…·,   â”‚ â”‚ - analyze   â”‚ â”‚ - search    â”‚              â”‚
â”‚   â”‚ - estimate  â”‚ â”‚  åªç”Ÿæˆ)   â”‚ â”‚ - check     â”‚ â”‚ - web_fetch â”‚              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 11.5.2 Agent å®šä¹‰ (ä½¿ç”¨é¡¹ç›®å·²é…ç½®çš„æ¨¡å‹)

```typescript
// supabase/functions/shared/agents.ts

import { ModelProvider, ModelConfig } from '../../../src/shared/types';

export interface AgentSpec {
  id: string;
  name: string;
  role: string;
  description: string;
  capabilities: string[];
  systemPrompt: string;
  // ä½¿ç”¨é¡¹ç›®å·²æ”¯æŒçš„æ¨¡å‹é…ç½®
  modelConfig: {
    provider: ModelProvider;  // 'deepseek' | 'claude' | 'openai' | 'groq' | 'zhipu' | 'qwen' | 'moonshot'
    model: string;            // å…·ä½“æ¨¡å‹ ID
    maxTokens: number;
    temperature?: number;
  };
  tools: string[];
}

/**
 * ä¸“ä¸šåŒ– Agent å®šä¹‰
 *
 * è¯´æ˜ï¼š
 * - æ¯ä¸ª Agent ä½¿ç”¨ç›¸åŒçš„åº•å±‚æ¨¡å‹ï¼ˆç”±ç”¨æˆ·é…ç½®å†³å®šï¼‰
 * - åŒºåˆ«åœ¨äº System Prompt å’Œå¯ç”¨å·¥å…·ä¸åŒ
 * - modelConfig æ˜¯é»˜è®¤é…ç½®ï¼Œå®é™…ä½¿ç”¨æ—¶ä¼šè¢«ç”¨æˆ·çš„æ¨¡å‹é€‰æ‹©è¦†ç›–
 * - é»˜è®¤ä½¿ç”¨ DeepSeekï¼Œå› ä¸ºå®ƒæ˜¯é¡¹ç›®çš„ä¸»è¦æ¨¡å‹
 */
export const AGENT_SPECS: Record<string, AgentSpec> = {
  planner: {
    id: 'planner',
    name: 'Planner Agent',
    role: 'ä»»åŠ¡è§„åˆ’ä¸åˆ†è§£',
    description: 'åˆ†æå¤æ‚ä»»åŠ¡ï¼Œç”Ÿæˆå¯æ‰§è¡Œçš„æ­¥éª¤è®¡åˆ’',
    capabilities: ['task_decomposition', 'dependency_analysis', 'resource_estimation'],
    systemPrompt: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä»»åŠ¡è§„åˆ’åŠ©æ‰‹ã€‚ä½ çš„èŒè´£æ˜¯:
1. åˆ†æç”¨æˆ·çš„å¤æ‚éœ€æ±‚
2. å°†ä»»åŠ¡åˆ†è§£ä¸ºåŸå­åŒ–ã€å¯æ‰§è¡Œçš„æ­¥éª¤
3. è¯†åˆ«æ­¥éª¤ä¹‹é—´çš„ä¾èµ–å…³ç³»
4. æ ‡è®°æ¯ä¸ªæ­¥éª¤éœ€è¦åœ¨æœ¬åœ°è¿˜æ˜¯äº‘ç«¯æ‰§è¡Œ
5. ä¼°ç®—æ¯ä¸ªæ­¥éª¤çš„èµ„æºéœ€æ±‚

è¾“å‡ºæ ¼å¼è¦æ±‚ JSON ç»“æ„åŒ–è®¡åˆ’ã€‚`,
    modelConfig: {
      provider: 'deepseek',
      model: 'deepseek-chat',      // æˆ– 'deepseek-reasoner' ç”¨äºå¤æ‚æ¨ç†
      maxTokens: 8000,
      temperature: 0.3,            // ä½æ¸©åº¦ï¼Œè¾“å‡ºæ›´ç¨³å®š
    },
    tools: ['analyze_codebase', 'estimate_complexity'],
  },

  coder: {
    id: 'coder',
    name: 'Coder Agent',
    role: 'ä»£ç å®ç°',
    description: 'æ ¹æ®è®¡åˆ’ç”Ÿæˆé«˜è´¨é‡ä»£ç ',
    capabilities: ['code_generation', 'refactoring', 'bug_fixing'],
    systemPrompt: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¼–ç¨‹åŠ©æ‰‹ã€‚ä½ çš„èŒè´£æ˜¯:
1. æ ¹æ®è§„åˆ’æ­¥éª¤ç”Ÿæˆä»£ç 
2. éµå¾ªé¡¹ç›®çš„ä»£ç é£æ ¼å’Œè§„èŒƒ
3. ç¼–å†™æ¸…æ™°ã€å¯ç»´æŠ¤çš„ä»£ç 
4. å¤„ç†è¾¹ç•Œæƒ…å†µå’Œé”™è¯¯

ä½ ç”Ÿæˆçš„ä»£ç å°†ç”±æœ¬åœ°æ‰§è¡Œå™¨å†™å…¥æ–‡ä»¶ã€‚`,
    modelConfig: {
      provider: 'deepseek',
      model: 'deepseek-coder',     // ä»£ç ä¸“ç”¨æ¨¡å‹
      maxTokens: 16000,
      temperature: 0.2,            // æ›´ä½æ¸©åº¦ï¼Œä»£ç ç”Ÿæˆæ›´å‡†ç¡®
    },
    tools: [],  // Coder åªç”Ÿæˆä»£ç ï¼Œä¸æ‰§è¡Œå·¥å…·
  },

  reviewer: {
    id: 'reviewer',
    name: 'Reviewer Agent',
    role: 'ä»£ç å®¡æŸ¥',
    description: 'å®¡æŸ¥ä»£ç è´¨é‡ã€å®‰å…¨æ€§å’Œæœ€ä½³å®è·µ',
    capabilities: ['code_review', 'security_audit', 'performance_analysis'],
    systemPrompt: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä»£ç å®¡æŸ¥åŠ©æ‰‹ã€‚ä½ çš„èŒè´£æ˜¯:
1. æ£€æŸ¥ä»£ç è´¨é‡å’Œå¯è¯»æ€§
2. è¯†åˆ«æ½œåœ¨çš„ bug å’Œå®‰å…¨æ¼æ´
3. éªŒè¯æ˜¯å¦éµå¾ªæœ€ä½³å®è·µ
4. æä¾›æ”¹è¿›å»ºè®®

å®¡æŸ¥æ ‡å‡†:
- ä»£ç æ­£ç¡®æ€§
- æ€§èƒ½è€ƒè™‘
- å®‰å…¨æ€§
- å¯ç»´æŠ¤æ€§
- æµ‹è¯•è¦†ç›–`,
    modelConfig: {
      provider: 'deepseek',
      model: 'deepseek-reasoner',  // ä½¿ç”¨æ¨ç†æ¨¡å‹åšæ·±åº¦åˆ†æ
      maxTokens: 8000,
      temperature: 0.4,
    },
    tools: ['analyze_code', 'check_security'],
  },

  researcher: {
    id: 'researcher',
    name: 'Researcher Agent',
    role: 'æŠ€æœ¯ç ”ç©¶',
    description: 'æœç´¢æ–‡æ¡£ã€æœ€ä½³å®è·µå’Œè§£å†³æ–¹æ¡ˆ',
    capabilities: ['documentation_search', 'best_practice_lookup', 'solution_research'],
    systemPrompt: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æŠ€æœ¯ç ”ç©¶åŠ©æ‰‹ã€‚ä½ çš„èŒè´£æ˜¯:
1. æœç´¢ç›¸å…³æŠ€æœ¯æ–‡æ¡£å’Œæœ€ä½³å®è·µ
2. åˆ†æç±»ä¼¼é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ
3. æä¾›æŠ€æœ¯å»ºè®®å’Œå‚è€ƒ
4. æ€»ç»“ç ”ç©¶å‘ç°

ä½ å¯ä»¥è®¿é—®å‘é‡æ•°æ®åº“è¿›è¡Œè¯­ä¹‰æœç´¢ã€‚`,
    modelConfig: {
      provider: 'deepseek',
      model: 'deepseek-chat',
      maxTokens: 4000,
      temperature: 0.5,
    },
    tools: ['semantic_search', 'web_fetch'],
  },

  documenter: {
    id: 'documenter',
    name: 'Documenter Agent',
    role: 'æ–‡æ¡£ç”Ÿæˆ',
    description: 'ç”Ÿæˆä»£ç æ–‡æ¡£ã€API æ–‡æ¡£å’Œç”¨æˆ·æŒ‡å—',
    capabilities: ['doc_generation', 'api_documentation', 'readme_writing'],
    systemPrompt: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æŠ€æœ¯æ–‡æ¡£ç¼–å†™åŠ©æ‰‹ã€‚ä½ çš„èŒè´£æ˜¯:
1. ä¸ºä»£ç ç”Ÿæˆæ¸…æ™°çš„æ–‡æ¡£
2. ç¼–å†™ API æ–‡æ¡£
3. åˆ›å»ºç”¨æˆ·æŒ‡å—å’Œ README
4. ä¿æŒæ–‡æ¡£ä¸ä»£ç åŒæ­¥

æ–‡æ¡£é£æ ¼è¦æ±‚æ¸…æ™°ã€ç®€æ´ã€æœ‰ç¤ºä¾‹ã€‚`,
    modelConfig: {
      provider: 'deepseek',
      model: 'deepseek-chat',
      maxTokens: 8000,
      temperature: 0.6,            // ç¨é«˜æ¸©åº¦ï¼Œæ–‡æ¡£å¯ä»¥æ›´è‡ªç„¶
    },
    tools: [],
  },
};

/**
 * æ ¹æ®ç”¨æˆ·é…ç½®è¦†ç›– Agent çš„æ¨¡å‹è®¾ç½®
 *
 * ç”¨æˆ·å¯ä»¥åœ¨è®¾ç½®ä¸­é€‰æ‹©ä¸åŒçš„æ¨¡å‹æä¾›å•†ï¼Œ
 * è¿™ä¸ªå‡½æ•°ä¼šç”¨ç”¨æˆ·çš„é€‰æ‹©è¦†ç›–é»˜è®¤é…ç½®
 */
export function resolveAgentModelConfig(
  agentId: string,
  userConfig: ModelConfig
): ModelConfig {
  const spec = AGENT_SPECS[agentId];
  if (!spec) {
    throw new Error(`Unknown agent: ${agentId}`);
  }

  // ç”¨æˆ·é…ç½®ä¼˜å…ˆï¼Œå¦åˆ™ä½¿ç”¨ Agent é»˜è®¤é…ç½®
  return {
    provider: userConfig.provider || spec.modelConfig.provider,
    model: userConfig.model || spec.modelConfig.model,
    apiKey: userConfig.apiKey,
    baseUrl: userConfig.baseUrl,
    maxTokens: spec.modelConfig.maxTokens,
    temperature: spec.modelConfig.temperature,
  };
}
```

#### 11.5.3 å¤šä»£ç†è°ƒåº¦å™¨ (Edge Function)

```typescript
// supabase/functions/agent-scheduler/index.ts

import { serve } from 'https://deno.land/std@0.177.0/http/server.ts';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
import { AGENT_SPECS, resolveAgentModelConfig } from '../shared/agents.ts';

const supabase = createClient(
  Deno.env.get('SUPABASE_URL')!,
  Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
);

const anthropic = new Anthropic({
  apiKey: Deno.env.get('ANTHROPIC_API_KEY'),
});

interface AgentMessage {
  role: 'user' | 'assistant';
  content: string;
}

interface AgentContext {
  taskId: string;
  agentId: string;
  messages: AgentMessage[];
  sharedState: Record<string, unknown>;
}

serve(async (req) => {
  const { taskId, action } = await req.json();

  if (action === 'schedule') {
    return await scheduleTask(taskId);
  } else if (action === 'execute_step') {
    return await executeStep(taskId);
  }

  return new Response(JSON.stringify({ error: 'Unknown action' }), {
    status: 400,
  });
});

async function scheduleTask(taskId: string) {
  // è·å–ä»»åŠ¡ä¿¡æ¯
  const { data: task } = await supabase
    .from('cloud_tasks')
    .select('*')
    .eq('id', taskId)
    .single();

  if (!task) {
    return new Response(JSON.stringify({ error: 'Task not found' }), {
      status: 404,
    });
  }

  // æ›´æ–°ä»»åŠ¡çŠ¶æ€
  await supabase
    .from('cloud_tasks')
    .update({ status: 'running', started_at: new Date().toISOString() })
    .eq('id', taskId);

  // æ ¹æ®ä»»åŠ¡ç±»å‹é€‰æ‹©æ‰§è¡Œç­–ç•¥
  switch (task.type) {
    case 'refactor_plan':
      await executeRefactorPlan(task);
      break;
    case 'code_review':
      await executeCodeReview(task);
      break;
    case 'multi_agent_task':
      await executeMultiAgentTask(task);
      break;
    default:
      await executeSingleAgentTask(task);
  }

  return new Response(JSON.stringify({ success: true }), { status: 200 });
}

/**
 * å¤šä»£ç†ååŒæ‰§è¡Œ
 */
async function executeMultiAgentTask(task: any) {
  const { input } = task;
  const sharedState: Record<string, unknown> = {};
  const logs: string[] = [];

  try {
    // Phase 1: Planner åˆ†æå’Œè§„åˆ’
    logs.push('Starting Planner Agent...');
    await updateTaskProgress(task.id, 10, 'Planning task...');

    const plannerResult = await runAgent('planner', {
      taskId: task.id,
      agentId: 'planner',
      messages: [
        {
          role: 'user',
          content: `è¯·åˆ†æä»¥ä¸‹ä»»åŠ¡å¹¶ç”Ÿæˆæ‰§è¡Œè®¡åˆ’:\n\n${JSON.stringify(input)}`,
        },
      ],
      sharedState,
    });

    sharedState.plan = plannerResult.output;
    logs.push(`Planner completed: ${plannerResult.tokensUsed} tokens`);

    // Phase 2: å¦‚æœéœ€è¦ç ”ç©¶ï¼Œå…ˆè¿è¡Œ Researcher
    if (input.requiresResearch) {
      logs.push('Starting Researcher Agent...');
      await updateTaskProgress(task.id, 25, 'Researching...');

      const researcherResult = await runAgent('researcher', {
        taskId: task.id,
        agentId: 'researcher',
        messages: [
          {
            role: 'user',
            content: `åŸºäºä»¥ä¸‹è®¡åˆ’ï¼Œè¯·ç ”ç©¶ç›¸å…³çš„æœ€ä½³å®è·µå’Œå‚è€ƒæ–¹æ¡ˆ:\n\n${JSON.stringify(sharedState.plan)}`,
          },
        ],
        sharedState,
      });

      sharedState.research = researcherResult.output;
      logs.push(`Researcher completed: ${researcherResult.tokensUsed} tokens`);
    }

    // Phase 3: Coder ç”Ÿæˆä»£ç 
    logs.push('Starting Coder Agent...');
    await updateTaskProgress(task.id, 50, 'Generating code...');

    const coderResult = await runAgent('coder', {
      taskId: task.id,
      agentId: 'coder',
      messages: [
        {
          role: 'user',
          content: `è¯·æ ¹æ®ä»¥ä¸‹è®¡åˆ’å’Œç ”ç©¶ç»“æœç”Ÿæˆä»£ç :

è®¡åˆ’: ${JSON.stringify(sharedState.plan)}
ç ”ç©¶: ${JSON.stringify(sharedState.research || 'æ— ')}

è¯·ç”Ÿæˆå¯ä»¥ç›´æ¥æ‰§è¡Œçš„ä»£ç ä¿®æ”¹æ­¥éª¤ã€‚`,
        },
      ],
      sharedState,
    });

    sharedState.code = coderResult.output;
    logs.push(`Coder completed: ${coderResult.tokensUsed} tokens`);

    // Phase 4: åˆ›å»ºéœ€è¦æœ¬åœ°æ‰§è¡Œçš„æ­¥éª¤
    const steps = parseCodeToSteps(coderResult.output);
    await createLocalExecutionSteps(task.id, steps);

    await updateTaskProgress(task.id, 70, 'Waiting for local execution...');

    // Phase 5: ç­‰å¾…æœ¬åœ°æ‰§è¡Œå®Œæˆ
    await waitForLocalStepsCompletion(task.id);

    // Phase 6: Reviewer å®¡æŸ¥
    logs.push('Starting Reviewer Agent...');
    await updateTaskProgress(task.id, 90, 'Reviewing changes...');

    const reviewerResult = await runAgent('reviewer', {
      taskId: task.id,
      agentId: 'reviewer',
      messages: [
        {
          role: 'user',
          content: `è¯·å®¡æŸ¥ä»¥ä¸‹ä»£ç ä¿®æ”¹:

åŸå§‹è®¡åˆ’: ${JSON.stringify(sharedState.plan)}
ç”Ÿæˆçš„ä»£ç : ${JSON.stringify(sharedState.code)}
æ‰§è¡Œç»“æœ: ${JSON.stringify(await getLocalExecutionResults(task.id))}

è¯·æä¾›è¯¦ç»†çš„å®¡æŸ¥æŠ¥å‘Šã€‚`,
        },
      ],
      sharedState,
    });

    sharedState.review = reviewerResult.output;
    logs.push(`Reviewer completed: ${reviewerResult.tokensUsed} tokens`);

    // å®Œæˆä»»åŠ¡
    await supabase
      .from('cloud_tasks')
      .update({
        status: 'completed',
        progress: 100,
        result: {
          plan: sharedState.plan,
          research: sharedState.research,
          code: sharedState.code,
          review: sharedState.review,
          logs,
        },
        completed_at: new Date().toISOString(),
      })
      .eq('id', task.id);

  } catch (error) {
    await supabase
      .from('cloud_tasks')
      .update({
        status: 'failed',
        error: { message: error.message, logs },
        completed_at: new Date().toISOString(),
      })
      .eq('id', task.id);
  }
}

/**
 * è¿è¡Œå•ä¸ª Agent
 */
async function runAgent(
  agentId: string,
  context: AgentContext
): Promise<{ output: string; tokensUsed: number }> {
  const spec = AGENT_SPECS[agentId];
  if (!spec) {
    throw new Error(`Unknown agent: ${agentId}`);
  }

  const response = await anthropic.messages.create({
    model: spec.modelPreference === 'claude-opus'
      ? 'claude-opus-4-20250514'
      : 'claude-sonnet-4-20250514',
    max_tokens: spec.maxTokens,
    system: spec.systemPrompt,
    messages: context.messages.map(m => ({
      role: m.role,
      content: m.content,
    })),
  });

  const output = response.content
    .filter(c => c.type === 'text')
    .map(c => c.text)
    .join('\n');

  // è®°å½•æ—¥å¿—
  await supabase.from('task_logs').insert({
    task_id: context.taskId,
    level: 'info',
    message: `Agent ${agentId} completed`,
    metadata: {
      tokensUsed: response.usage.input_tokens + response.usage.output_tokens,
      model: response.model,
    },
    agent_id: agentId,
  });

  return {
    output,
    tokensUsed: response.usage.input_tokens + response.usage.output_tokens,
  };
}

async function updateTaskProgress(
  taskId: string,
  progress: number,
  currentStep: string
) {
  await supabase
    .from('cloud_tasks')
    .update({ progress, current_step: currentStep })
    .eq('id', taskId);
}

async function createLocalExecutionSteps(taskId: string, steps: any[]) {
  const stepRecords = steps.map((step, index) => ({
    task_id: taskId,
    step_index: index,
    name: step.name,
    description: step.description,
    status: 'pending',
    requires_local_execution: step.target === 'local',
    local_execution_request: step.target === 'local' ? {
      tool: step.tool,
      arguments: step.arguments,
      context: step.context,
    } : null,
  }));

  await supabase.from('task_steps').insert(stepRecords);
}

async function waitForLocalStepsCompletion(taskId: string): Promise<void> {
  // è½®è¯¢ç­‰å¾…æœ¬åœ°æ­¥éª¤å®Œæˆ
  const maxWaitTime = 30 * 60 * 1000; // 30 åˆ†é’Ÿ
  const startTime = Date.now();

  while (Date.now() - startTime < maxWaitTime) {
    const { data: pendingSteps } = await supabase
      .from('task_steps')
      .select('id')
      .eq('task_id', taskId)
      .eq('requires_local_execution', true)
      .in('status', ['pending', 'running']);

    if (!pendingSteps?.length) {
      return;
    }

    await new Promise(resolve => setTimeout(resolve, 5000));
  }

  throw new Error('Timeout waiting for local execution');
}

async function getLocalExecutionResults(taskId: string) {
  const { data } = await supabase
    .from('task_steps')
    .select('*')
    .eq('task_id', taskId)
    .eq('requires_local_execution', true)
    .order('step_index');

  return data?.map(s => ({
    step: s.name,
    result: s.local_execution_result,
    status: s.status,
  }));
}

function parseCodeToSteps(codeOutput: string): any[] {
  // è§£æ Coder Agent è¾“å‡ºçš„ä»£ç ä¸ºå¯æ‰§è¡Œæ­¥éª¤
  // å®é™…å®ç°éœ€è¦æ ¹æ®è¾“å‡ºæ ¼å¼è¿›è¡Œè§£æ
  try {
    return JSON.parse(codeOutput);
  } catch {
    return [];
  }
}
```

### 11.6 è·¨è®¾å¤‡ä»»åŠ¡ç»­æ¥

#### 11.6.1 è®¾è®¡åŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Cross-Device Task Continuation                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åœºæ™¯: ç”¨æˆ·åœ¨æ‰‹æœºä¸Šæäº¤ä»»åŠ¡ï¼Œäº‘ç«¯æ‰§è¡Œï¼Œç”µè„‘ä¸ŠæŸ¥çœ‹ç»“æœ

Timeline:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

10:00 AM â”‚ ğŸ“± Phone                    â”‚ â˜ï¸ Cloud                â”‚ ğŸ’» Desktop
         â”‚                             â”‚                         â”‚
         â”‚ User submits task:          â”‚                         â”‚
         â”‚ "Review auth module"        â”‚                         â”‚
         â”‚         â”‚                   â”‚                         â”‚
         â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ Task created            â”‚
         â”‚                             â”‚ Status: pending         â”‚
         â”‚                             â”‚         â”‚               â”‚
         â”‚                             â”‚         â–¼               â”‚
         â”‚                             â”‚ Planner Agent starts    â”‚
         â”‚                             â”‚ Status: running         â”‚
         â”‚                             â”‚         â”‚               â”‚
10:05 AM â”‚                             â”‚         â–¼               â”‚
         â”‚                             â”‚ Reviewer Agent starts   â”‚
         â”‚                             â”‚ Progress: 50%           â”‚
         â”‚                             â”‚         â”‚               â”‚
10:10 AM â”‚                             â”‚         â–¼               â”‚ User opens app
         â”‚                             â”‚ Task completed          â”‚         â”‚
         â”‚                             â”‚ Status: completed       â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                             â”‚         â”‚               â”‚
         â”‚                             â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ Auto-sync
         â”‚                             â”‚                         â”‚ Show results
         â”‚                             â”‚                         â”‚
         â”‚ Push notification:          â”‚                         â”‚
         â”‚ "Review complete!"          â”‚                         â”‚
         â”‚                             â”‚                         â”‚
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

#### 11.6.2 å®¢æˆ·ç«¯åŒæ­¥å®ç°

```typescript
// src/main/cloud/TaskSyncService.ts

export class TaskSyncService {
  private supabase: SupabaseClient;
  private localDb: DatabaseService;
  private eventEmitter: EventEmitter;
  private realtimeChannel: RealtimeChannel | null = null;

  constructor() {
    this.supabase = SupabaseService.getInstance().getClient();
    this.localDb = DatabaseService.getInstance();
    this.eventEmitter = new EventEmitter();
  }

  /**
   * åˆå§‹åŒ–åŒæ­¥
   */
  async initialize(): Promise<void> {
    // 1. åŒæ­¥æœ¬åœ°ç¼“å­˜çš„ä»»åŠ¡çŠ¶æ€
    await this.syncLocalTasks();

    // 2. è®¢é˜…å®æ—¶æ›´æ–°
    this.subscribeToRealtimeUpdates();

    // 3. æ£€æŸ¥å¾…å¤„ç†çš„æœ¬åœ°æ‰§è¡Œè¯·æ±‚
    await this.checkPendingLocalExecutions();
  }

  /**
   * åŒæ­¥æœ¬åœ°ä»»åŠ¡ç¼“å­˜
   */
  private async syncLocalTasks(): Promise<void> {
    const lastSyncTime = await this.localDb.getLastTaskSyncTime();

    const { data: tasks } = await this.supabase
      .from('cloud_tasks')
      .select('*')
      .gt('updated_at', lastSyncTime || '1970-01-01')
      .order('updated_at', { ascending: true });

    for (const task of tasks || []) {
      await this.localDb.upsertCloudTask(task);
      this.eventEmitter.emit('task_updated', task);
    }

    await this.localDb.setLastTaskSyncTime(new Date().toISOString());
  }

  /**
   * è®¢é˜…å®æ—¶æ›´æ–°
   */
  private subscribeToRealtimeUpdates(): void {
    this.realtimeChannel = this.supabase
      .channel('task-updates')
      .on(
        'postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: 'cloud_tasks',
        },
        async (payload) => {
          const task = payload.new as any;

          // æ›´æ–°æœ¬åœ°ç¼“å­˜
          await this.localDb.upsertCloudTask(task);

          // å‘é€äº‹ä»¶
          this.eventEmitter.emit('task_updated', task);

          // å¦‚æœä»»åŠ¡å®Œæˆï¼Œæ˜¾ç¤ºé€šçŸ¥
          if (task.status === 'completed' && task.notify_on_complete) {
            this.showNotification(task);
          }
        }
      )
      .on(
        'postgres_changes',
        {
          event: 'INSERT',
          schema: 'public',
          table: 'task_steps',
          filter: 'requires_local_execution=eq.true',
        },
        async (payload) => {
          const step = payload.new as any;

          // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰è®¾å¤‡éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡
          const task = await this.localDb.getCloudTask(step.task_id);
          if (task?.device_id === await this.getDeviceId()) {
            this.eventEmitter.emit('local_execution_required', step);
          }
        }
      )
      .subscribe();
  }

  /**
   * æ£€æŸ¥å¾…å¤„ç†çš„æœ¬åœ°æ‰§è¡Œ
   */
  private async checkPendingLocalExecutions(): Promise<void> {
    const deviceId = await this.getDeviceId();

    const { data: steps } = await this.supabase
      .from('task_steps')
      .select('*, cloud_tasks!inner(device_id)')
      .eq('requires_local_execution', true)
      .eq('status', 'pending')
      .eq('cloud_tasks.device_id', deviceId);

    for (const step of steps || []) {
      this.eventEmitter.emit('local_execution_required', step);
    }
  }

  /**
   * æ˜¾ç¤ºç³»ç»Ÿé€šçŸ¥
   */
  private showNotification(task: any): void {
    const { Notification } = require('electron');

    new Notification({
      title: 'Task Completed',
      body: `${task.name} has been completed`,
      icon: path.join(__dirname, '../assets/icon.png'),
    }).show();
  }

  /**
   * è·å–ä»»åŠ¡åˆ—è¡¨ (æœ¬åœ°ç¼“å­˜ + äº‘ç«¯)
   */
  async getTasks(options?: {
    status?: string[];
    includeCompleted?: boolean;
  }): Promise<CloudTask[]> {
    // ä¼˜å…ˆè¿”å›æœ¬åœ°ç¼“å­˜
    const localTasks = await this.localDb.getCloudTasks(options);

    // åå°åˆ·æ–°
    this.syncLocalTasks().catch(console.error);

    return localTasks;
  }

  on(event: string, listener: (...args: any[]) => void): void {
    this.eventEmitter.on(event, listener);
  }

  async cleanup(): Promise<void> {
    if (this.realtimeChannel) {
      await this.realtimeChannel.unsubscribe();
    }
  }

  private async getDeviceId(): Promise<string> {
    return ConfigService.getInstance().getDeviceId();
  }
}
```

### 11.7 ä»£é™…èƒ½åŠ›å¢å¼ºæ˜ å°„

| ä»£é™… | ç°æœ‰èƒ½åŠ› | äº‘ç«¯å¢å¼º | å®ç°æ–¹å¼ |
|------|----------|----------|----------|
| **Gen 5** | memory_store, memory_search, code_index | è·¨é¡¹ç›®çŸ¥è¯†åº“ã€å…±äº«è®°å¿† | pgvector äº‘ç«¯å­˜å‚¨ + è¯­ä¹‰æ£€ç´¢ |
| **Gen 6** | screenshot, computer_use | è¿œç¨‹è®¾å¤‡æ§åˆ¶ (æœªæ¥) | WebRTC + äº‘ç«¯ä¸­ç»§ |
| **Gen 7** | spawn_agent, workflow_orchestrate | å¤šä»£ç†å¹¶è¡Œè°ƒåº¦ã€ä¸“ä¸šåŒ–åˆ†å·¥ | Claude Agent SDK + Edge Functions |
| **Gen 8** | tool_create, self_evaluate | ç­–ç•¥å…±äº«ã€å·¥å…·å¸‚åœº | äº‘ç«¯ç­–ç•¥åº“ + å·¥å…·æ³¨å†Œè¡¨ |

### 11.8 æ–°å¢æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ main/
â”‚   â”œâ”€â”€ cloud/                          # äº‘ç«¯æœåŠ¡å±‚ (æ–°å¢)
â”‚   â”‚   â”œâ”€â”€ TaskRouter.ts              # ä»»åŠ¡è·¯ç”±å™¨
â”‚   â”‚   â”œâ”€â”€ CloudTaskService.ts        # äº‘ç«¯ä»»åŠ¡æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ HybridTaskCoordinator.ts   # æ··åˆä»»åŠ¡åè°ƒå™¨
â”‚   â”‚   â”œâ”€â”€ TaskSyncService.ts         # ä»»åŠ¡åŒæ­¥æœåŠ¡
â”‚   â”‚   â””â”€â”€ CloudClient.ts             # äº‘ç«¯è¿æ¥ç®¡ç†
â”‚   â”‚
â”‚   â””â”€â”€ services/
â”‚       â””â”€â”€ DatabaseService.ts          # æ‰©å±•: æœ¬åœ°ä»»åŠ¡ç¼“å­˜
â”‚
â”œâ”€â”€ renderer/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ CloudTaskList.tsx          # äº‘ç«¯ä»»åŠ¡åˆ—è¡¨ (æ–°å¢)
â”‚   â”‚   â”œâ”€â”€ TaskProgress.tsx           # ä»»åŠ¡è¿›åº¦æ˜¾ç¤º (æ–°å¢)
â”‚   â”‚   â””â”€â”€ LocalExecutionPrompt.tsx   # æœ¬åœ°æ‰§è¡Œç¡®è®¤ (æ–°å¢)
â”‚   â”‚
â”‚   â””â”€â”€ hooks/
â”‚       â””â”€â”€ useCloudTasks.ts           # äº‘ç«¯ä»»åŠ¡ Hook (æ–°å¢)
â”‚
â””â”€â”€ shared/
    â””â”€â”€ types/
        â””â”€â”€ cloud.ts                    # äº‘ç«¯ç›¸å…³ç±»å‹ (æ–°å¢)

supabase/
â”œâ”€â”€ functions/
â”‚   â”œâ”€â”€ agent-scheduler/               # Agent è°ƒåº¦å™¨ (æ–°å¢)
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ task-processor/                # ä»»åŠ¡å¤„ç†å™¨ (æ–°å¢)
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â””â”€â”€ shared/
â”‚       â””â”€â”€ agents.ts                  # Agent å®šä¹‰ (æ–°å¢)
â”‚
â””â”€â”€ migrations/
    â””â”€â”€ 20260117_cloud_tasks.sql       # äº‘ç«¯ä»»åŠ¡è¡¨ (æ–°å¢)
```

### 11.9 é…ç½®ä¸ç¯å¢ƒå˜é‡

```env
# .env æ–°å¢é…ç½®

# äº‘ç«¯ä»»åŠ¡é…ç½®
CLOUD_TASK_ENABLED=true
CLOUD_TASK_DEFAULT_TIMEOUT=3600
CLOUD_TASK_MAX_RETRIES=3

# Agent SDK é…ç½®
ANTHROPIC_API_KEY=sk-ant-xxx
AGENT_MODEL_PLANNER=claude-sonnet-4-20250514
AGENT_MODEL_CODER=claude-sonnet-4-20250514
AGENT_MODEL_REVIEWER=claude-opus-4-20250514

# å®æ—¶åŒæ­¥é…ç½®
REALTIME_ENABLED=true
SYNC_INTERVAL_MS=30000
```

### 11.10 å®‰å…¨è€ƒè™‘

| å…³æ³¨ç‚¹ | é£é™© | ç¼“è§£æªæ–½ |
|--------|------|----------|
| **æ•æ„Ÿä»£ç ä¸Šä¼ ** | ä»£ç æ³„éœ² | æœ¬åœ°æ‰§è¡Œæ•æ„Ÿæ“ä½œï¼Œåªä¸Šä¼ å…ƒæ•°æ® |
| **å‡­è¯æš´éœ²** | å¯†é’¥æ³„éœ² | å‡­è¯æ°¸ä¸ä¸Šä¼ ï¼Œä½¿ç”¨ SecureStorage |
| **äº‘ç«¯ä»»åŠ¡æ³¨å…¥** | æ¶æ„ä»£ç æ‰§è¡Œ | æœ¬åœ°æ‰§è¡Œå‰ç”¨æˆ·ç¡®è®¤ï¼Œæ²™ç®±éš”ç¦» |
| **è·¨è®¾å¤‡æ•°æ®åŒæ­¥** | æ•°æ®æ³„éœ² | ç«¯åˆ°ç«¯åŠ å¯† (å¯é€‰)ï¼ŒRLS ç­–ç•¥ |
| **Agent è¾“å‡ºéªŒè¯** | é”™è¯¯/æ¶æ„ä»£ç  | Reviewer Agent å®¡æŸ¥ï¼Œæœ¬åœ°æ‰§è¡Œå‰é¢„è§ˆ |
