# Agent æ ¸å¿ƒæ¶æ„

> æœ¬æ–‡æ¡£è¯¦ç»†æè¿° Agent çš„æ ¸å¿ƒç»„ä»¶ï¼šAgentOrchestratorã€AgentLoopã€è§„åˆ’ç³»ç»Ÿ

## æ•°æ®æµæ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ‘¤ ç”¨æˆ·è¾“å…¥éœ€æ±‚   â”‚ "å¸®æˆ‘å†™ä¸€ä¸ªè´ªåƒè›‡æ¸¸æˆ"
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼ [IPC: agent:send-message]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ä¸»è¿›ç¨‹ - AgentOrchestrator                          â”‚
â”‚  1. åˆ›å»º User Message { id, role: 'user', content, timestamp }              â”‚
â”‚  2. è·å– ModelConfig (DeepSeek API Key, Model ID)                           â”‚
â”‚  3. åˆ›å»º AgentLoop å®ä¾‹                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              AgentLoop.run()                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€ è¿­ä»£ N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                                                                   â”‚    â”‚
â”‚   â”‚  1ï¸âƒ£ INFERENCE é˜¶æ®µ                                               â”‚    â”‚
â”‚   â”‚     buildModelMessages() â†’ ModelRouter.inference()                â”‚    â”‚
â”‚   â”‚                                                                   â”‚    â”‚
â”‚   â”‚  2ï¸âƒ£ å“åº”å¤„ç†åˆ†æ”¯                                                 â”‚    â”‚
â”‚   â”‚     â”Œâ”€ type === 'text' â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚   â”‚     â”‚ â€¢ åˆ›å»º assistantMessage â†’ onEvent â†’ BREAK              â”‚   â”‚    â”‚
â”‚   â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚   â”‚     â”Œâ”€ type === 'tool_use' â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚   â”‚     â”‚ â€¢ æ‰§è¡Œå·¥å…· â†’ åˆ›å»º toolMessage â†’ CONTINUE               â”‚   â”‚    â”‚
â”‚   â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚   â”‚                                                                   â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                             â”‚
â”‚   onEvent({ type: 'agent_complete' })                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## AgentOrchestrator

**ä½ç½®**: `src/main/agent/AgentOrchestrator.ts`

**èŒè´£**:
- ç®¡ç†å¯¹è¯æ¶ˆæ¯å†å²
- å¤„ç†æƒé™è¯·æ±‚/å“åº”
- è·å–æ¨¡å‹é…ç½®
- åˆ›å»ºå’Œå¯åŠ¨ AgentLoop
- å¤„ç†ä»£é™…åˆ‡æ¢

**å…³é”®æ–¹æ³•**:
```typescript
sendMessage(content: string): Promise<void>
  â”œâ”€ åˆ›å»º user message
  â”œâ”€ æ·»åŠ åˆ°å†å²
  â”œâ”€ è·å– ModelConfig
  â”œâ”€ åˆ›å»º AgentLoop
  â””â”€ è¿è¡Œ loop

requestPermission(request): Promise<boolean>
  â”œâ”€ æ£€æŸ¥ AUTO_TEST æ¨¡å¼
  â”œâ”€ æ£€æŸ¥ autoApprove è®¾ç½®
  â””â”€ å‘é€æƒé™è¯·æ±‚äº‹ä»¶ï¼Œç­‰å¾…ç”¨æˆ·å“åº”
```

## AgentLoop

**ä½ç½®**: `src/main/agent/AgentLoop.ts`

**æ ¸å¿ƒå¾ªç¯**:
```typescript
while (!isCancelled && iterations < 50) {
  iterations++;

  // 1. æ¨ç†
  response = await inference();

  // 2. å¤„ç†å“åº”
  if (response.type === 'text') {
    // Stop Hook éªŒè¯ â†’ åˆ›å»ºåŠ©æ‰‹æ¶ˆæ¯ â†’ å‘é€äº‹ä»¶ â†’ BREAK
  }

  if (response.type === 'tool_use') {
    // Pre-Tool Hook â†’ æ‰§è¡Œå·¥å…· â†’ Anti-pattern Detection â†’ Post-Tool Hook
    // åˆ›å»ºå·¥å…·ç»“æœæ¶ˆæ¯ â†’ CONTINUE
  }
}
```

**å¢å¼ºåŠŸèƒ½**:
1. **ä»»åŠ¡å¤æ‚åº¦åˆ†æ** - åœ¨ `run()` å¼€å§‹æ—¶è‡ªåŠ¨æ£€æµ‹ä»»åŠ¡ç±»å‹
2. **Anti-pattern Detection** - æ£€æµ‹è¿ç»­è¯»æ“ä½œï¼Œé˜²æ­¢æ— é™å¾ªç¯
3. **Planning Hooks** - é›†æˆè§„åˆ’ç³»ç»Ÿçš„ç”Ÿå‘½å‘¨æœŸé’©å­
4. **Turn-Based Message Model** - åŸºäºè¡Œä¸šæœ€ä½³å®è·µçš„æ¶ˆæ¯æµæ¶æ„

---

## Turn-Based æ¶ˆæ¯æµæ¶æ„

> è¯¦è§ ADR: [001-turn-based-messaging.md](../decisions/001-turn-based-messaging.md)

**è®¾è®¡æ¥æº**: å€Ÿé‰´ Vercel AI SDK å’Œ LangGraph çš„æœ€ä½³å®è·µ

**æ ¸å¿ƒåŸåˆ™**:
- æ¯è½® Agent Loop è¿­ä»£å¯¹åº”ä¸€æ¡å‰ç«¯ assistant æ¶ˆæ¯
- åç«¯é©±åŠ¨æ¶ˆæ¯åˆ›å»ºï¼ˆé€šè¿‡ `turn_start` äº‹ä»¶ï¼‰
- ä½¿ç”¨ `turnId` å…³è”åŒä¸€è½®çš„æ‰€æœ‰äº‹ä»¶

**äº‹ä»¶æµç¨‹**:

```
turn_start â†’ stream_chunk* â†’ stream_tool_call_start? â†’ tool_call_end â†’ turn_end
    |                                                                       |
    v                                                                       v
åˆ›å»ºæ–° assistant æ¶ˆæ¯                                                æ ‡è®°æœ¬è½®å®Œæˆ
```

**äº‹ä»¶ç±»å‹è¯´æ˜**:

| äº‹ä»¶ | è§¦å‘æ—¶æœº | æºå¸¦æ•°æ® | å‰ç«¯å¤„ç† |
|------|----------|----------|----------|
| `turn_start` | è¿­ä»£å¼€å§‹ | `{ turnId, iteration }` | åˆ›å»ºæ–° assistant æ¶ˆæ¯ |
| `stream_chunk` | æ–‡æœ¬æµå¼è¾“å‡º | `{ content, turnId }` | è¿½åŠ åˆ°ç›®æ ‡æ¶ˆæ¯ |
| `stream_tool_call_start` | å·¥å…·è°ƒç”¨æµå¼å¼€å§‹ | `{ index, id, name, turnId }` | æ·»åŠ å·¥å…·è°ƒç”¨å¡ç‰‡ |
| `tool_call_end` | å·¥å…·æ‰§è¡Œå®Œæˆ | `{ toolCallId, success, output }` | æ˜¾ç¤ºæ‰§è¡Œç»“æœ |
| `turn_end` | è¿­ä»£ç»“æŸ | `{ turnId }` | å¯é€‰çš„ UI æ›´æ–° |

**å®ç°ä½ç½®**:

| æ–‡ä»¶ | èŒè´£ |
|------|------|
| `AgentLoop.ts` | ç”Ÿæˆ turnIdï¼Œå‘é€ turn_start/turn_end äº‹ä»¶ |
| `useAgent.ts` | å¤„ç†äº‹ä»¶ï¼Œä½¿ç”¨ turnId å®šä½å’Œæ›´æ–°æ¶ˆæ¯ |
| `types.ts` | å®šä¹‰ AgentEvent ç±»å‹ï¼ˆå« turnIdï¼‰ |

---

## ä»»åŠ¡å¤æ‚åº¦åˆ†æç³»ç»Ÿ

**ä½ç½®**: `src/main/planning/TaskComplexityAnalyzer.ts`

**åŠŸèƒ½**: åœ¨ AI æ‰§è¡Œå‰è‡ªåŠ¨æ£€æµ‹ä»»åŠ¡å¤æ‚åº¦ï¼Œæ³¨å…¥ç›¸åº”çš„æ‰§è¡Œç­–ç•¥æç¤ºã€‚

```
ç”¨æˆ·è¾“å…¥ â†’ å¤æ‚åº¦åˆ†æ â†’ æ³¨å…¥æç¤º â†’ AI æ‰§è¡Œ
              â†“
      "create snake game"
              â†“
      Detected: SIMPLE (85%)
              â†“
      AI æ”¶åˆ°: "Skip planning, use write_file NOW"
```

**å¤æ‚åº¦åˆ†ç±»**:

| å¤æ‚åº¦ | æ£€æµ‹æŒ‡æ ‡ | å»ºè®®è¡Œä¸º | å·¥å…·è°ƒç”¨æ¬¡æ•° |
|--------|----------|----------|--------------|
| **SIMPLE** | "create a"ã€çŸ­æ¶ˆæ¯ã€å•æ–‡ä»¶ä»»åŠ¡ | è·³è¿‡è§„åˆ’ï¼Œç›´æ¥ `write_file` | 1-3 æ¬¡ |
| **MODERATE** | "add feature"ã€"fix bug" | ç®€çŸ­è§„åˆ’ï¼ˆ3-5 é¡¹ï¼‰ | 5-10 æ¬¡ |
| **COMPLEX** | "refactor"ã€"migrate"ã€å¤šæ­¥éª¤ | å®Œæ•´è§„åˆ’ï¼Œåˆ†é˜¶æ®µæ‰§è¡Œ | 10-30+ æ¬¡ |

---

## è§„åˆ’ç³»ç»Ÿ (Planning System)

**ä½ç½®**: `src/main/planning/`

**ç»„ä»¶ç»“æ„**:

```
planning/
â”œâ”€â”€ PlanManager.ts           # è®¡åˆ’æŒä¹…åŒ–ç®¡ç†
â”œâ”€â”€ HooksEngine.ts           # ç”Ÿå‘½å‘¨æœŸé’©å­å¼•æ“
â”œâ”€â”€ ErrorTracker.ts          # é”™è¯¯è¿½è¸ª (3-Strike Rule)
â”œâ”€â”€ FindingsManager.ts       # å‘ç°ç®¡ç†
â”œâ”€â”€ TaskComplexityAnalyzer.ts # ä»»åŠ¡å¤æ‚åº¦åˆ†æ
â”œâ”€â”€ PlanningService.ts       # ç»Ÿä¸€æœåŠ¡å…¥å£
â””â”€â”€ types.ts                 # ç±»å‹å®šä¹‰
```

**HooksEngine é’©å­**:

| é’©å­ | è§¦å‘æ—¶æœº | åŠŸèƒ½ |
|------|----------|------|
| `onSessionStart` | ä¼šè¯å¼€å§‹ | æ£€æŸ¥æœªå®Œæˆè®¡åˆ’ï¼Œé‡ç½®è®¡æ•°å™¨ |
| `preToolUse` | å·¥å…·æ‰§è¡Œå‰ | æ³¨å…¥é”™è¯¯å†å²ï¼Œæé†’å½“å‰ä»»åŠ¡ |
| `postToolUse` | å·¥å…·æ‰§è¡Œå | 2-Action è§„åˆ™ï¼Œæ›´æ–°è¿›åº¦æé†’ |
| `onStop` | AI å‡†å¤‡åœæ­¢ | éªŒè¯è®¡åˆ’å®Œæˆåº¦ï¼Œå†³å®šæ˜¯å¦å¼ºåˆ¶ç»§ç»­ |
| `onError` | å‘ç”Ÿé”™è¯¯ | è®°å½•é”™è¯¯ï¼Œæ£€æŸ¥ 3-Strike è§„åˆ™ |

---

## Anti-pattern Detection

**ä½ç½®**: `AgentLoop.ts` å†…ç½®

**åŠŸèƒ½**: æ£€æµ‹ AI é™·å…¥æ— é™è¯»å–å¾ªç¯çš„æƒ…å†µã€‚

**æ£€æµ‹è§„åˆ™**:

| é˜¶æ®µ | é˜ˆå€¼ | è§¦å‘æ¡ä»¶ | è­¦å‘Šå†…å®¹ |
|------|------|----------|----------|
| **åˆ›å»ºå‰** | 5 æ¬¡ | è¿ç»­ 5 æ¬¡ read æ“ä½œ | "åœæ­¢é˜…è¯»ï¼Œç«‹å³åˆ›å»ºï¼" |
| **åˆ›å»ºå** | 10 æ¬¡ | å†™å…¥åè¿ç»­ 10 æ¬¡ read | "ä»»åŠ¡å¯èƒ½å·²å®Œæˆï¼Œåœæ­¢è¿‡åº¦éªŒè¯ï¼" |

**è§£å†³çš„é—®é¢˜**:
- AI åˆ›å»ºæ–‡ä»¶åé™·å…¥æ— é™éªŒè¯å¾ªç¯
- AI åœ¨åˆ›å»ºä»»åŠ¡ä¸­è¿‡åº¦ç ”ç©¶è€Œä¸åŠ¨æ‰‹
- Stop Hook è¿‡äºæ¿€è¿›å¯¼è‡´çš„å¼ºåˆ¶ç»§ç»­

---

## ModelRouter

**ä½ç½®**: `src/main/model/ModelRouter.ts`

**æ”¯æŒçš„æ¨¡å‹æä¾›å•†**:

| Provider | æ¨¡å‹ | ç‰¹æ€§ |
|----------|------|------|
| DeepSeek | deepseek-chat, deepseek-reasoner | ä¸»è¦ä½¿ç”¨ |
| OpenAI | gpt-4o, gpt-4o-mini | å¤‡é€‰ |
| Claude | claude-sonnet-4, claude-opus-4 | é«˜çº§æ¨ç† |
| Groq | llama-3.3-70b | å¿«é€Ÿæ¨ç† |
| æ™ºè°± | glm-4-plus | ä¸­æ–‡ä¼˜åŒ– |
| é€šä¹‰åƒé—® | qwen-max, qwen-coder-plus | ä»£ç ä¸“ç”¨ |
| Moonshot | moonshot-v1-128k | è¶…é•¿ä¸Šä¸‹æ–‡ |
