# æ•°æ®å­˜å‚¨æ¶æ„

> SQLite + Supabase + pgvector

## æœ¬åœ°å­˜å‚¨ (SQLite)

**ä½ç½®**: `~/.code-agent/data.db`

```sql
-- sessions è¡¨
CREATE TABLE sessions (
  id TEXT PRIMARY KEY,
  title TEXT,
  generation_id TEXT NOT NULL,
  working_directory TEXT,
  created_at INTEGER,
  updated_at INTEGER
);

-- messages è¡¨
CREATE TABLE messages (
  id TEXT PRIMARY KEY,
  session_id TEXT NOT NULL,
  role TEXT NOT NULL,
  content TEXT NOT NULL,
  tool_calls TEXT,     -- JSON
  tool_results TEXT,   -- JSON
  timestamp INTEGER,
  FOREIGN KEY (session_id) REFERENCES sessions(id)
);
```

## äº‘ç«¯å­˜å‚¨ (Supabase)

**è¡¨ç»“æ„**:

| è¡¨å | ç”¨é€” | åŒæ­¥ç­–ç•¥ |
|------|------|----------|
| `profiles` | ç”¨æˆ·èµ„æ–™ | å•å‘äº‘ç«¯ |
| `devices` | è®¾å¤‡ç®¡ç† | åŒå‘ |
| `sessions` | ä¼šè¯è®°å½• | å¢é‡åŒæ­¥ |
| `messages` | å¯¹è¯æ¶ˆæ¯ | å¢é‡åŒæ­¥ |
| `user_preferences` | ç”¨æˆ·åå¥½ | Last-Write-Wins |
| `vector_documents` | å‘é‡å­˜å‚¨ | ä»…ä¸Šä¼  |

## å‘é‡æ•°æ®åº“

**æ‰©å±•**: pgvector (Supabase åŸç”Ÿæ”¯æŒ)
**ç»´åº¦**: 1024 (DeepSeek embedding)
**ç´¢å¼•**: HNSW (cosine è·ç¦»)
**ç”¨é€”**: è¯­ä¹‰æœç´¢ã€é•¿æœŸè®°å¿†ã€RAG ä¸Šä¸‹æ–‡

---

## æ•°æ®åˆ†å±‚æ¶æ„ (5 Levels)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          æ•°æ®åˆ†å±‚æ¶æ„ (5 Levels)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Level 4 â”€â”€â”€ è·¨è®¾å¤‡æ•°æ® (Supabase cloud)                                    â”‚
â”‚  â”‚           â””â”€â”€ ä¼šè¯å†å²ã€æ¶ˆæ¯å†…å®¹ã€ç”¨æˆ·èµ„æ–™                                â”‚
â”‚  â”‚                                                                          â”‚
â”‚  Level 3 â”€â”€â”€ äº‘ç«¯åŒæ­¥ (Supabase + Keychain)                                 â”‚
â”‚  â”‚           â””â”€â”€ ç™»å½•çŠ¶æ€ã€è®¤è¯ tokenã€ç”¨æˆ·åå¥½                              â”‚
â”‚  â”‚                                                                          â”‚
â”‚  Level 2 â”€â”€â”€ æœ¬åœ°æ•°æ® (Keychain + config.json)                              â”‚
â”‚  â”‚           â””â”€â”€ ä»£é™…é€‰æ‹©ã€ç•Œé¢è®¾ç½®ã€API Key                                 â”‚
â”‚  â”‚                                                                          â”‚
â”‚  Level 1 â”€â”€â”€ æœ¬åœ°ç¼“å­˜ (SQLite)                                              â”‚
â”‚  â”‚           â””â”€â”€ å·¥å…·æ‰§è¡Œç¼“å­˜ã€ä¼šè¯/æ¶ˆæ¯æœ¬åœ°å‰¯æœ¬ï¼ˆå¯ä»äº‘ç«¯æ¢å¤ï¼‰              â”‚
â”‚  â”‚                                                                          â”‚
â”‚  Level 0 â”€â”€â”€ å†…å­˜ç¼“å­˜ (ToolCache LRU)                                       â”‚
â”‚              â””â”€â”€ è¿è¡Œæ—¶ç¼“å­˜ã€é‡å¯æ¸…ç©º                                        â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å„å±‚çº§è¯¦è§£**:

| å±‚çº§ | å­˜å‚¨ä½ç½® | ç”Ÿå‘½å‘¨æœŸ | æ¸…ç©ºç¼“å­˜ | é‡å¯åº”ç”¨ | é‡è£…åº”ç”¨ | æ¢ç”µè„‘ |
|------|----------|----------|:--------:|:--------:|:--------:|:------:|
| **L0** | å†…å­˜ (ToolCache) | è¿è¡Œæ—¶ | ğŸ—‘ï¸ | ğŸ—‘ï¸ | ğŸ—‘ï¸ | ğŸ—‘ï¸ |
| **L1** | SQLite | å¯æ¸…ç©º | ğŸ—‘ï¸ | âœ… | ğŸ—‘ï¸ | ğŸ—‘ï¸ |
| **L2** | Keychain + config.json | æœ¬åœ°æŒä¹… | âœ… | âœ… | âš ï¸ | ğŸ—‘ï¸ |
| **L3** | Supabase + Keychain | è´¦æˆ·ç»‘å®š | âœ… | âœ… | âœ… | âœ…* |
| **L4** | Supabase äº‘ç«¯ | è´¦æˆ·ç»‘å®š | âœ… | âœ… | âœ… | âœ… |

> âš ï¸ = Keychain æ•°æ®å¯æ¢å¤ï¼ˆä»…é™åŒä¸€å° Macï¼‰
> âœ…* = éœ€è¦é‡æ–°ç™»å½•

---

## ä¼šè¯æ¸è¿›åŠ è½½ç­–ç•¥

```
æ‰“å¼€åº”ç”¨
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è¿”å›æœ¬åœ°ç¼“å­˜çš„ä¼šè¯åˆ—è¡¨ï¼ˆå³æ—¶å“åº”ï¼‰    â”‚
â”‚ 2. åå°ä»äº‘ç«¯åŒæ­¥æœ€æ–°åˆ—è¡¨               â”‚
â”‚ 3. æœ‰æ›´æ–°åˆ™é€šçŸ¥å‰ç«¯åˆ·æ–°                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
ç”¨æˆ·ç‚¹å‡»æŸä¸ªä¼šè¯
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    å¦     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœ¬åœ°æœ‰æ¶ˆæ¯ï¼Ÿ â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ ä»äº‘ç«¯æ‹‰å–æ¶ˆæ¯   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚ ç¼“å­˜åˆ°æœ¬åœ°       â”‚
     â”‚ æ˜¯                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â–¼                            â”‚
æ˜¾ç¤ºä¼šè¯å†…å®¹ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç¼“å­˜ç­–ç•¥

**L0 å†…å­˜ç¼“å­˜ (ToolCache)**:
- å®ç°: `src/main/services/ToolCache.ts`
- ç­–ç•¥: LRU ç¼“å­˜ï¼Œæœ€å¤š 100 æ¡
- TTL: read_file 5åˆ†é’Ÿ, glob/grep 2åˆ†é’Ÿ, web_fetch 15åˆ†é’Ÿ
- ä¸å¯ç¼“å­˜: bash, write_file, edit_file (æœ‰å‰¯ä½œç”¨)

**L1 æœ¬åœ°ç¼“å­˜ (SQLite)**:
- è¡¨: `tool_executions` - å·¥å…·æ‰§è¡Œç»“æœç¼“å­˜
- è¡¨: `sessions` - ä¼šè¯åˆ—è¡¨æœ¬åœ°å‰¯æœ¬
- è¡¨: `messages` - æ¶ˆæ¯å†…å®¹æœ¬åœ°å‰¯æœ¬
- æ¸…ç©ºç¼“å­˜åå¯ä»äº‘ç«¯é‡æ–°æ‹‰å–

**L2 æœ¬åœ°æ•°æ® (Keychain æ¢å¤)**:
```typescript
// ConfigService.syncToKeychain()
{
  generation: 'gen3',
  modelProvider: 'deepseek',
  language: 'zh',
  disclosureLevel: 'standard',
  devModeAutoApprove: true,
}
```

---

## ç”¨æˆ·æ“ä½œæ˜ å°„

| ç”¨æˆ·æ“ä½œ | æ¸…ç†èŒƒå›´ | ä¿ç•™ | æ¢å¤æ–¹å¼ |
|----------|----------|------|----------|
| æ¸…ç©ºç¼“å­˜ | L0 + L1 | L2/L3/L4 | è‡ªåŠ¨ä»äº‘ç«¯æ‹‰å– |
| é€€å‡ºç™»å½• | L3 token | L0/L1/L2/L4 | é‡æ–°ç™»å½• |
| é‡è£…åº”ç”¨ | L0 + L1 | L2(Keychain) + L3/L4 | ç™»å½•åè‡ªåŠ¨æ¢å¤ |

---

## SecureStorage å®‰å…¨å­˜å‚¨ï¼ˆv0.6.4ï¼‰

**ä½ç½®**: `src/main/services/SecureStorage.ts`

### è®¾è®¡åŸåˆ™

1. **æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨** - ä½¿ç”¨ electron-store çš„åŠ å¯†åŠŸèƒ½
2. **æœºå™¨ç»‘å®šå¯†é’¥** - åŠ å¯†å¯†é’¥åŸºäºæœºå™¨ç‰¹å¾ç”Ÿæˆï¼Œä¸å¯è¿ç§»
3. **åˆ†å±‚å­˜å‚¨ç­–ç•¥** - æ™®é€šé…ç½® vs Keychainï¼ˆè·¨é‡è£…ä¿æŒï¼‰

### åŠ å¯†æœºåˆ¶

```typescript
// æœºå™¨ç‰¹å¾ç”ŸæˆåŠ å¯†å¯†é’¥
const machineId = `${os.hostname()}-${os.userInfo().username}-${app.getPath('userData')}`;
const encryptionKey = crypto.createHash('sha256').update(machineId).digest('hex').slice(0, 32);
```

### å­˜å‚¨å†…å®¹

| ç±»åˆ« | æ•°æ®é¡¹ | å­˜å‚¨ä½ç½® |
|------|--------|----------|
| **è®¤è¯** | access_token, refresh_token, session | åŠ å¯†å­˜å‚¨ |
| **è®¾å¤‡** | device_id, device_name | åŠ å¯†å­˜å‚¨ |
| **API Key** | deepseek, claude, openai, groq ç­‰ | åŠ å¯†å­˜å‚¨ |
| **è®¾ç½®** | devModeAutoApprove | Keychainï¼ˆè·¨é‡è£…ï¼‰ |
| **ä¼šè¯** | supabase session | Keychainï¼ˆè·¨é‡è£…ï¼‰ |

### API Key ç®¡ç†

```typescript
// è®¾ç½® API Key
secureStorage.setApiKey('deepseek', 'sk-xxx');

// è·å– API Key
const key = secureStorage.getApiKey('deepseek');

// åˆ é™¤ API Key
secureStorage.deleteApiKey('deepseek');

// åˆ—å‡ºå·²é…ç½®çš„ Provider
const providers = secureStorage.getStoredApiKeyProviders();
// â†’ ['deepseek', 'openai']
```

### Keychain é›†æˆ

ä½¿ç”¨ `keytar` åº“è®¿é—®ç³»ç»Ÿ Keychainï¼Œæ•°æ®å¯åœ¨åº”ç”¨é‡è£…åæ¢å¤ï¼š

| æ–¹æ³• | ç”¨é€” |
|------|------|
| `saveSessionToKeychain()` | ä¿å­˜ç™»å½•ä¼šè¯ |
| `getSessionFromKeychain()` | æ¢å¤ç™»å½•çŠ¶æ€ |
| `saveSettingsToKeychain()` | ä¿å­˜ç”¨æˆ·è®¾ç½® |
| `getSettingsFromKeychain()` | æ¢å¤ç”¨æˆ·è®¾ç½® |

**Keychain æ ‡è¯†**:
- Service: `code-agent`
- Account: `supabase-session` / `user-settings`
