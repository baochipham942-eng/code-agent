# 统一指挥家架构 (Unified Orchestrator)

> 实现纯云端 / 混合 / 纯本地三种执行模式的智能调度

## 设计目标

1. **智能路由** - 根据任务特征自动选择最优执行路径
2. **云端自治** - 云端具备独立执行能力，不依赖本地在线
3. **混合协作** - 复杂任务支持云端规划 + 本地执行 + 云端审查
4. **代际融合** - 各代际工具能力无缝融入三种执行模式

---

## 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          Unified Orchestrator Architecture                           │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                              用户请求入口                                     │   │
│   │                     "抓取竞品价格" / "重构 auth 模块"                         │   │
│   └───────────────────────────────────┬─────────────────────────────────────────┘   │
│                                       │                                              │
│                                       ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                         ① TaskAnalyzer 任务分析器                            │   │
│   │  ┌─────────────────────────────────────────────────────────────────────┐    │   │
│   │  │  输入: 用户 prompt + 上下文                                          │    │   │
│   │  │  输出:                                                               │    │   │
│   │  │    • 任务类型 (research/coding/automation/data)                     │    │   │
│   │  │    • 所需能力 (file_access/shell/network/browser/memory)            │    │   │
│   │  │    • 敏感度等级 (public/internal/sensitive)                          │    │   │
│   │  │    • 预估复杂度 (simple/moderate/complex)                            │    │   │
│   │  │    • 实时性要求 (realtime/async/batch)                               │    │   │
│   │  └─────────────────────────────────────────────────────────────────────┘    │   │
│   └───────────────────────────────────┬─────────────────────────────────────────┘   │
│                                       │                                              │
│                                       ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                         ② ExecutionRouter 执行路由器                         │   │
│   │  ┌─────────────────────────────────────────────────────────────────────┐    │   │
│   │  │                         路由决策矩阵                                  │    │   │
│   │  │                                                                      │    │   │
│   │  │   需要本地文件? ──Yes──► 需要复杂推理? ──Yes──► HYBRID                │    │   │
│   │  │        │                      │                                      │    │   │
│   │  │        No                     No                                     │    │   │
│   │  │        │                      │                                      │    │   │
│   │  │        ▼                      ▼                                      │    │   │
│   │  │   需要浏览器? ──Yes──► LOCAL                                         │    │   │
│   │  │        │                                                             │    │   │
│   │  │        No                                                            │    │   │
│   │  │        │                                                             │    │   │
│   │  │        ▼                                                             │    │   │
│   │  │   纯网络/分析? ──Yes──► CLOUD                                        │    │   │
│   │  │        │                                                             │    │   │
│   │  │        No                                                            │    │   │
│   │  │        │                                                             │    │   │
│   │  │        ▼                                                             │    │   │
│   │  │      LOCAL (默认)                                                    │    │   │
│   │  └─────────────────────────────────────────────────────────────────────┘    │   │
│   └──────────────┬────────────────────┬────────────────────┬────────────────────┘   │
│                  │                    │                    │                        │
│         ┌───────┴───────┐    ┌───────┴───────┐    ┌───────┴───────┐                │
│         ▼               ▼    ▼               ▼    ▼               ▼                │
│   ┌───────────┐   ┌───────────┐   ┌─────────────────────────────────┐              │
│   │   CLOUD   │   │   LOCAL   │   │            HYBRID               │              │
│   │  Executor │   │  Executor │   │          Coordinator            │              │
│   └─────┬─────┘   └─────┬─────┘   └───────────────┬─────────────────┘              │
│         │               │                         │                                │
│         ▼               ▼                         ▼                                │
│   ┌───────────┐   ┌───────────┐   ┌─────────────────────────────────┐              │
│   │Cloud Agent│   │Local Agent│   │  Cloud    →  Local   →  Cloud   │              │
│   │   Loop    │   │   Loop    │   │ (规划)      (执行)      (审查)   │              │
│   └───────────┘   └───────────┘   └─────────────────────────────────┘              │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 三种执行模式详解

### 模式 1: 纯云端 (CLOUD)

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              CLOUD Executor 纯云端执行                               │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│   适用场景:                                                                          │
│   • 网页数据抓取、API 聚合                                                           │
│   • 代码审查、文档生成                                                               │
│   • 跨项目语义搜索                                                                   │
│   • 长时间运行的后台任务                                                             │
│                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                         CloudAgentLoop                                       │   │
│   │                                                                              │   │
│   │   ┌─────────────────────────────────────────────────────────────────────┐   │   │
│   │   │                     Cloud Native Tools                               │   │   │
│   │   │                                                                      │   │   │
│   │   │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐       │   │   │
│   │   │  │cloud_fetch │ │cloud_scrape│ │cloud_search│ │cloud_api   │       │   │   │
│   │   │  │ HTTP 请求  │ │ 网页解析   │ │ 多引擎搜索 │ │ API 调用   │       │   │   │
│   │   │  └────────────┘ └────────────┘ └────────────┘ └────────────┘       │   │   │
│   │   │                                                                      │   │   │
│   │   │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐       │   │   │
│   │   │  │cloud_store │ │cloud_query │ │cloud_cache │ │cloud_sandbox│      │   │   │
│   │   │  │ 数据存储   │ │ 数据查询   │ │ 结果缓存   │ │ 代码沙箱   │       │   │   │
│   │   │  └────────────┘ └────────────┘ └────────────┘ └────────────┘       │   │   │
│   │   │                                                                      │   │   │
│   │   │  ┌────────────┐ ┌────────────┐ ┌────────────┐                       │   │   │
│   │   │  │code_review │ │explain_code│ │generate_doc│                       │   │   │
│   │   │  │ 代码审查   │ │ 代码解释   │ │ 文档生成   │                       │   │   │
│   │   │  └────────────┘ └────────────┘ └────────────┘                       │   │   │
│   │   └─────────────────────────────────────────────────────────────────────┘   │   │
│   │                                                                              │   │
│   │   执行环境: Vercel Edge Functions / Supabase Edge Functions                 │   │
│   │   存储: Supabase Postgres + pgvector + R2/S3                                │   │
│   │   特点: 无需本地在线，支持定时任务，可后台运行                               │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 模式 2: 纯本地 (LOCAL)

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              LOCAL Executor 纯本地执行                               │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│   适用场景:                                                                          │
│   • 文件读写、代码编辑                                                               │
│   • 终端命令执行 (npm, git, docker)                                                 │
│   • 浏览器自动化、截图                                                               │
│   • 涉及敏感数据的操作                                                               │
│   • 需要实时 UI 交互                                                                 │
│                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                         LocalAgentLoop (现有)                                │   │
│   │                                                                              │   │
│   │   ┌─────────────────────────────────────────────────────────────────────┐   │   │
│   │   │  Gen1-2: 文件系统      Gen3: 规划交互      Gen4: 网络              │   │   │
│   │   │  ┌─────────┐          ┌─────────┐         ┌─────────┐              │   │   │
│   │   │  │  bash   │          │  task   │         │  skill  │              │   │   │
│   │   │  │read_file│          │todo_write│        │web_fetch│              │   │   │
│   │   │  │write_file│         │ask_user │         │         │              │   │   │
│   │   │  │edit_file│          │plan_mode│         │         │              │   │   │
│   │   │  │  glob   │          └─────────┘         └─────────┘              │   │   │
│   │   │  │  grep   │                                                        │   │   │
│   │   │  └─────────┘                                                        │   │   │
│   │   │                                                                      │   │   │
│   │   │  Gen5: 记忆           Gen6: 视觉           Gen7-8: 高级             │   │   │
│   │   │  ┌─────────┐          ┌─────────┐         ┌─────────┐              │   │   │
│   │   │  │memory_  │          │screenshot│        │spawn_   │              │   │   │
│   │   │  │ store   │          │computer_│         │ agent   │              │   │   │
│   │   │  │memory_  │          │  use    │         │workflow_│              │   │   │
│   │   │  │ search  │          │browser_ │         │orchestrate│            │   │   │
│   │   │  │code_index│         │ action  │         │tool_create│            │   │   │
│   │   │  └─────────┘          └─────────┘         └─────────┘              │   │   │
│   │   └─────────────────────────────────────────────────────────────────────┘   │   │
│   │                                                                              │   │
│   │   执行环境: Electron 主进程                                                  │   │
│   │   存储: 本地 SQLite + 内存                                                   │   │
│   │   特点: 完整工具访问，实时交互，敏感数据安全                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 模式 3: 混合协作 (HYBRID)

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           HYBRID Coordinator 混合协作模式                            │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│   适用场景:                                                                          │
│   • 大型重构（云端规划 + 本地执行 + 云端审查）                                       │
│   • 数据采集入库（云端抓取 + 本地处理 + 云端存储）                                   │
│   • 复杂调试（云端分析 + 本地修复 + 云端验证）                                       │
│                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                              │   │
│   │   Phase 1: CLOUD PLANNING (云端规划)                                        │   │
│   │   ┌─────────────────────────────────────────────────────────────────────┐   │   │
│   │   │  Planner Agent 分析任务，生成执行计划:                               │   │   │
│   │   │                                                                      │   │   │
│   │   │  {                                                                   │   │   │
│   │   │    "steps": [                                                        │   │   │
│   │   │      { "id": 1, "action": "create_file", "target": "LOCAL" },       │   │   │
│   │   │      { "id": 2, "action": "edit_file",   "target": "LOCAL" },       │   │   │
│   │   │      { "id": 3, "action": "run_tests",   "target": "LOCAL" },       │   │   │
│   │   │      { "id": 4, "action": "code_review", "target": "CLOUD" }        │   │   │
│   │   │    ],                                                                │   │   │
│   │   │    "dependencies": { "4": [1,2,3] }                                  │   │   │
│   │   │  }                                                                   │   │   │
│   │   └─────────────────────────────────────────────────────────────────────┘   │   │
│   │                                    │                                         │   │
│   │                                    ▼ 计划下发                                │   │
│   │                                                                              │   │
│   │   Phase 2: LOCAL EXECUTION (本地执行)                                       │   │
│   │   ┌─────────────────────────────────────────────────────────────────────┐   │   │
│   │   │  Local Agent 按计划执行:                                             │   │   │
│   │   │                                                                      │   │   │
│   │   │  Step 1: write_file('src/utils/helpers.ts', content) ✅             │   │   │
│   │   │  Step 2: edit_file('src/auth/service.ts', changes)   ✅             │   │   │
│   │   │  Step 3: bash('npm test')                            ✅             │   │   │
│   │   │                                                                      │   │   │
│   │   │  实时进度上报 ────────────────────────────────► 云端任务状态更新    │   │   │
│   │   └─────────────────────────────────────────────────────────────────────┘   │   │
│   │                                    │                                         │   │
│   │                                    ▼ 执行结果                                │   │
│   │                                                                              │   │
│   │   Phase 3: CLOUD REVIEW (云端审查)                                          │   │
│   │   ┌─────────────────────────────────────────────────────────────────────┐   │   │
│   │   │  Reviewer Agent 审查执行结果:                                        │   │   │
│   │   │                                                                      │   │   │
│   │   │  ┌─────────────────────────────────────────────────────────────┐    │   │   │
│   │   │  │ ✅ 代码结构改善                                              │    │   │   │
│   │   │  │ ✅ 函数职责单一                                              │    │   │   │
│   │   │  │ ⚠️ 建议: 添加 JSDoc 注释                                     │    │   │   │
│   │   │  │ ✅ 所有测试通过                                              │    │   │   │
│   │   │  └─────────────────────────────────────────────────────────────┘    │   │   │
│   │   │                                                                      │   │   │
│   │   │  如有建议 → 生成后续步骤 → 返回 Phase 2                            │   │   │
│   │   └─────────────────────────────────────────────────────────────────────┘   │   │
│   │                                                                              │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 与代际能力的融合

### 各代际在三种模式下的角色

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                            代际能力 × 执行模式 矩阵                                  │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│   ┌─────────┬──────────────────┬──────────────────┬──────────────────┐              │
│   │  代际   │      CLOUD       │      LOCAL       │      HYBRID      │              │
│   ├─────────┼──────────────────┼──────────────────┼──────────────────┤              │
│   │         │                  │                  │                  │              │
│   │  Gen1   │ ❌ 不适用        │ ✅ 文件操作执行  │ ✅ 本地执行阶段  │              │
│   │ 基础IO  │                  │   bash/read/     │   write/edit     │              │
│   │         │                  │   write/edit     │                  │              │
│   ├─────────┼──────────────────┼──────────────────┼──────────────────┤              │
│   │         │                  │                  │                  │              │
│   │  Gen2   │ ❌ 不适用        │ ✅ 代码搜索      │ ✅ 本地执行阶段  │              │
│   │ 搜索    │                  │   glob/grep      │   分析+定位      │              │
│   │         │                  │                  │                  │              │
│   ├─────────┼──────────────────┼──────────────────┼──────────────────┤              │
│   │         │                  │                  │                  │              │
│   │  Gen3   │ ✅ 云端规划      │ ✅ 本地规划      │ ✅ 云端规划阶段  │              │
│   │ 规划    │   generate_plan  │   task/todo      │   Planner Agent  │              │
│   │         │   task_decompose │   ask_user       │   计划生成       │              │
│   ├─────────┼──────────────────┼──────────────────┼──────────────────┤              │
│   │         │                  │                  │                  │              │
│   │  Gen4   │ ✅ 云端数据获取  │ ✅ 本地网络      │ ✅ 云端数据采集  │              │
│   │ 网络    │   cloud_scrape   │   web_fetch      │   + 本地处理     │              │
│   │         │   cloud_search   │   skill          │                  │              │
│   │         │   cloud_api      │                  │                  │              │
│   ├─────────┼──────────────────┼──────────────────┼──────────────────┤              │
│   │         │                  │                  │                  │              │
│   │  Gen5   │ ✅ 云端记忆库    │ ✅ 本地记忆      │ ✅ 跨设备记忆    │              │
│   │ 记忆    │   cloud_memory   │   memory_store   │   云端存储       │              │
│   │         │   semantic_search│   memory_search  │   本地检索       │              │
│   │         │   跨项目检索     │   code_index     │                  │              │
│   ├─────────┼──────────────────┼──────────────────┼──────────────────┤              │
│   │         │                  │                  │                  │              │
│   │  Gen6   │ ⚠️ 云端分析      │ ✅ 本地视觉      │ ✅ 本地截图      │              │
│   │ 视觉    │   screenshot     │   screenshot     │   + 云端分析     │              │
│   │         │   图像分析       │   computer_use   │                  │              │
│   │         │   (需上传)       │   browser_action │                  │              │
│   ├─────────┼──────────────────┼──────────────────┼──────────────────┤              │
│   │         │                  │                  │                  │              │
│   │  Gen7   │ ✅ 云端多Agent   │ ✅ 本地多Agent   │ ✅ 云端调度      │              │
│   │ 多代理  │   cloud_orchestrate│  spawn_agent   │   + 本地执行     │              │
│   │         │   Planner/Coder/ │   agent_message  │   Reviewer审查   │              │
│   │         │   Reviewer/      │   workflow_      │                  │              │
│   │         │   Researcher     │   orchestrate    │                  │              │
│   ├─────────┼──────────────────┼──────────────────┼──────────────────┤              │
│   │         │                  │                  │                  │              │
│   │  Gen8   │ ✅ 云端策略库    │ ✅ 本地演进      │ ✅ 策略共享      │              │
│   │ 演进    │   strategy_sync  │   strategy_opt   │   云端学习       │              │
│   │         │   跨用户学习     │   tool_create    │   本地应用       │              │
│   │         │                  │   self_evaluate  │                  │              │
│   └─────────┴──────────────────┴──────────────────┴──────────────────┘              │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 代际能力在 HYBRID 模式的典型流程

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                      示例: "重构 auth 模块，提取公共逻辑"                             │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │ PHASE 1: CLOUD PLANNING                                                      │   │
│   │ ─────────────────────────────────────────────────────────────────────────── │   │
│   │                                                                              │   │
│   │ Gen5 云端记忆: semantic_search("auth refactoring patterns")                 │   │
│   │      → 检索到过往类似重构的最佳实践                                          │   │
│   │                                                                              │   │
│   │ Gen7 Planner Agent: 分析代码结构，生成重构计划                              │   │
│   │      → 输出 5 个执行步骤 + 依赖关系                                          │   │
│   │                                                                              │   │
│   │ Gen8 策略优化: 加载用户偏好的代码风格策略                                    │   │
│   │      → 提示 Coder Agent 遵循特定命名规范                                     │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                       │                                              │
│                                       ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │ PHASE 2: LOCAL EXECUTION                                                     │   │
│   │ ─────────────────────────────────────────────────────────────────────────── │   │
│   │                                                                              │   │
│   │ Gen2 代码搜索: glob("**/auth/**") + grep("validateToken")                   │   │
│   │      → 定位所有需要修改的文件                                                │   │
│   │                                                                              │   │
│   │ Gen1 文件操作:                                                               │   │
│   │      → write_file('src/utils/authHelpers.ts', newCode)                      │   │
│   │      → edit_file('src/auth/service.ts', changes)                            │   │
│   │      → bash('npm test')                                                      │   │
│   │                                                                              │   │
│   │ Gen3 进度同步: todo_write(更新完成状态)                                      │   │
│   │      → 实时上报云端任务进度                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                       │                                              │
│                                       ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │ PHASE 3: CLOUD REVIEW                                                        │   │
│   │ ─────────────────────────────────────────────────────────────────────────── │   │
│   │                                                                              │   │
│   │ Gen7 Reviewer Agent: 审查代码变更                                           │   │
│   │      → 检查代码质量、安全性、最佳实践                                        │   │
│   │                                                                              │   │
│   │ Gen5 记忆存储: memory_store("auth_refactor_pattern", insights)              │   │
│   │      → 存储本次重构的经验教训                                                │   │
│   │                                                                              │   │
│   │ Gen8 自我评估: self_evaluate(任务完成质量)                                   │   │
│   │      → 更新策略权重，优化未来决策                                            │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 云端工具补充设计

### 需要新增的云端原生工具

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              Cloud Native Tools 设计                                 │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                          网络数据获取 (Gen4 云端增强)                         │   │
│   │                                                                              │   │
│   │  cloud_fetch                                                                 │   │
│   │  ├─ 功能: HTTP 请求 (GET/POST/PUT/DELETE)                                   │   │
│   │  ├─ 增强: 自动重试、代理支持、请求签名                                       │   │
│   │  └─ 实现: Vercel Edge Functions                                             │   │
│   │                                                                              │   │
│   │  cloud_scrape                                                                │   │
│   │  ├─ 功能: 网页抓取 + 结构化解析                                              │   │
│   │  ├─ 增强: CSS 选择器、XPath、JSON-LD 提取                                   │   │
│   │  └─ 实现: cheerio + 无头浏览器 (Puppeteer/Playwright on Cloud)              │   │
│   │                                                                              │   │
│   │  cloud_search                                                                │   │
│   │  ├─ 功能: 多引擎搜索聚合 (Google/Bing/DuckDuckGo)                           │   │
│   │  ├─ 增强: 去重、排序、摘要生成                                               │   │
│   │  └─ 实现: SerpAPI / 自建爬虫                                                 │   │
│   │                                                                              │   │
│   │  cloud_api                                                                   │   │
│   │  ├─ 功能: 通用 API 调用 (REST/GraphQL)                                       │   │
│   │  ├─ 增强: OAuth 认证、速率限制、响应缓存                                     │   │
│   │  └─ 实现: Edge Functions + KV 缓存                                          │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                          数据处理 (Gen5 云端增强)                             │   │
│   │                                                                              │   │
│   │  cloud_transform                                                             │   │
│   │  ├─ 功能: 数据格式转换 (JSON/CSV/XML/Markdown)                              │   │
│   │  ├─ 增强: 批量处理、流式转换                                                 │   │
│   │  └─ 实现: Edge Functions                                                     │   │
│   │                                                                              │   │
│   │  cloud_analyze                                                               │   │
│   │  ├─ 功能: 数据分析 (统计/趋势/异常检测)                                      │   │
│   │  ├─ 增强: 可视化输出、报告生成                                               │   │
│   │  └─ 实现: Edge Functions + AI 辅助                                          │   │
│   │                                                                              │   │
│   │  cloud_memory                                                                │   │
│   │  ├─ 功能: 云端向量存储 + 语义检索                                            │   │
│   │  ├─ 增强: 跨项目检索、相似度排序                                             │   │
│   │  └─ 实现: Supabase pgvector                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                          存储与缓存                                           │   │
│   │                                                                              │   │
│   │  cloud_storage                                                               │   │
│   │  ├─ 功能: 临时文件存储 (上传/下载)                                           │   │
│   │  ├─ 增强: 自动过期、访问控制                                                 │   │
│   │  └─ 实现: Supabase Storage / R2                                             │   │
│   │                                                                              │   │
│   │  cloud_cache                                                                 │   │
│   │  ├─ 功能: 结果缓存 (KV 存储)                                                 │   │
│   │  ├─ 增强: TTL、LRU 淘汰                                                      │   │
│   │  └─ 实现: Vercel KV / Upstash Redis                                         │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                          代码执行沙箱 (可选)                                  │   │
│   │                                                                              │   │
│   │  cloud_sandbox                                                               │   │
│   │  ├─ 功能: 安全代码执行 (JS/TS/Python)                                        │   │
│   │  ├─ 增强: 资源限制、超时控制、隔离环境                                       │   │
│   │  └─ 实现: Deno Deploy / Cloudflare Workers / Val.town                       │   │
│   │                                                                              │   │
│   │  注意: 沙箱执行能力属于高级功能，需要谨慎评估安全风险                        │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 路由决策详细规则

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              ExecutionRouter 决策规则                                │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                              决策优先级 (从高到低)                            │   │
│   │                                                                              │   │
│   │  P1: 安全规则 (强制)                                                         │   │
│   │  ────────────────────────────────────────────────────────────────────────── │   │
│   │  • 涉及敏感数据 (密钥/凭证/个人信息) → LOCAL                                 │   │
│   │  • 涉及本地文件系统写入 → LOCAL                                              │   │
│   │  • 涉及危险命令 (rm -rf, sudo) → LOCAL + 权限确认                           │   │
│   │                                                                              │   │
│   │  P2: 能力约束 (必须)                                                         │   │
│   │  ────────────────────────────────────────────────────────────────────────── │   │
│   │  • 需要本地文件读取 → LOCAL 或 HYBRID                                        │   │
│   │  • 需要本地 Shell 执行 → LOCAL 或 HYBRID                                     │   │
│   │  • 需要浏览器自动化 → LOCAL                                                  │   │
│   │  • 需要截图/键鼠操作 → LOCAL                                                 │   │
│   │                                                                              │   │
│   │  P3: 效率优化 (建议)                                                         │   │
│   │  ────────────────────────────────────────────────────────────────────────── │   │
│   │  • 纯网络数据获取 → CLOUD (更稳定)                                           │   │
│   │  • 长时间后台任务 → CLOUD (不阻塞本地)                                       │   │
│   │  • 复杂推理/规划 → CLOUD (算力更强)                                          │   │
│   │  • 跨项目检索 → CLOUD (数据集中)                                             │   │
│   │                                                                              │   │
│   │  P4: 用户偏好 (可配置)                                                       │   │
│   │  ────────────────────────────────────────────────────────────────────────── │   │
│   │  • 用户明确指定位置 → 尊重用户选择                                           │   │
│   │  • 离线模式 → 全部 LOCAL                                                     │   │
│   │  • 省电模式 → 优先 CLOUD                                                     │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                              任务类型 → 执行模式 映射                         │   │
│   │                                                                              │   │
│   │  ┌────────────────────┬─────────┬──────────────────────────────────────┐    │   │
│   │  │ 任务类型           │  模式   │ 说明                                  │    │   │
│   │  ├────────────────────┼─────────┼──────────────────────────────────────┤    │   │
│   │  │ 文件创建/编辑      │ LOCAL   │ 需要本地文件系统                      │    │   │
│   │  │ 终端命令执行       │ LOCAL   │ 需要本地 Shell                        │    │   │
│   │  │ Git 操作           │ LOCAL   │ 需要本地仓库                          │    │   │
│   │  │ 浏览器自动化       │ LOCAL   │ 需要本地浏览器                        │    │   │
│   │  │ 截图/录屏          │ LOCAL   │ 需要本地屏幕                          │    │   │
│   │  ├────────────────────┼─────────┼──────────────────────────────────────┤    │   │
│   │  │ 网页数据抓取       │ CLOUD   │ 纯网络操作                            │    │   │
│   │  │ API 数据聚合       │ CLOUD   │ 纯网络操作                            │    │   │
│   │  │ 代码审查           │ CLOUD   │ 纯推理任务                            │    │   │
│   │  │ 文档生成           │ CLOUD   │ 纯推理任务                            │    │   │
│   │  │ 跨项目搜索         │ CLOUD   │ 云端数据集中                          │    │   │
│   │  │ 定时任务           │ CLOUD   │ 不依赖本地在线                        │    │   │
│   │  ├────────────────────┼─────────┼──────────────────────────────────────┤    │   │
│   │  │ 大型重构           │ HYBRID  │ 云端规划 + 本地执行                   │    │   │
│   │  │ 数据采集入库       │ HYBRID  │ 云端抓取 + 本地处理                   │    │   │
│   │  │ 复杂调试           │ HYBRID  │ 云端分析 + 本地修复                   │    │   │
│   │  │ 多文件生成         │ HYBRID  │ 云端规划 + 本地写入                   │    │   │
│   │  └────────────────────┴─────────┴──────────────────────────────────────┘    │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 通信协议设计

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           云端 ↔ 本地 通信协议                                       │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                              任务下发 (Cloud → Local)                        │   │
│   │                                                                              │   │
│   │  WebSocket Message:                                                          │   │
│   │  {                                                                           │   │
│   │    "type": "task_dispatch",                                                  │   │
│   │    "taskId": "uuid",                                                         │   │
│   │    "action": "execute_step",                                                 │   │
│   │    "step": {                                                                 │   │
│   │      "id": 1,                                                                │   │
│   │      "tool": "write_file",                                                   │   │
│   │      "params": { "path": "...", "content": "..." }                          │   │
│   │    },                                                                        │   │
│   │    "context": { "planId": "...", "phase": "execution" }                     │   │
│   │  }                                                                           │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                              结果上报 (Local → Cloud)                        │   │
│   │                                                                              │   │
│   │  WebSocket Message:                                                          │   │
│   │  {                                                                           │   │
│   │    "type": "task_result",                                                    │   │
│   │    "taskId": "uuid",                                                         │   │
│   │    "stepId": 1,                                                              │   │
│   │    "status": "success" | "failed",                                          │   │
│   │    "result": { ... },                                                        │   │
│   │    "duration": 1234,                                                         │   │
│   │    "nextStepReady": true                                                     │   │
│   │  }                                                                           │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                              进度同步 (双向)                                 │   │
│   │                                                                              │   │
│   │  REST API:                                                                   │   │
│   │  POST /api/tasks/{taskId}/progress                                          │   │
│   │  {                                                                           │   │
│   │    "progress": 60,                                                           │   │
│   │    "currentStep": "Running tests",                                          │   │
│   │    "completedSteps": 3,                                                      │   │
│   │    "totalSteps": 5,                                                          │   │
│   │    "logs": [...]                                                             │   │
│   │  }                                                                           │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 文件结构规划

```
src/
├── main/
│   ├── orchestrator/                    # 统一指挥家
│   │   ├── UnifiedOrchestrator.ts       # 主入口
│   │   ├── TaskAnalyzer.ts              # 任务分析器
│   │   ├── ExecutionRouter.ts           # 执行路由器 (升级自 TaskRouter)
│   │   ├── CloudExecutor.ts             # 云端执行器
│   │   ├── LocalExecutor.ts             # 本地执行器 (封装现有 AgentLoop)
│   │   ├── HybridCoordinator.ts         # 混合协调器
│   │   └── types.ts                     # 类型定义
│   │
│   ├── cloud/
│   │   ├── CloudClient.ts               # 云端通信客户端
│   │   ├── WebSocketManager.ts          # WebSocket 连接管理
│   │   ├── TaskSyncService.ts           # 任务状态同步
│   │   └── types.ts
│   │
│   └── agent/                           # 现有代码
│       ├── AgentOrchestrator.ts         # 重构为 LocalExecutor 的一部分
│       └── AgentLoop.ts

cloud-agent/
├── api/
│   ├── orchestrator/
│   │   ├── analyze.ts                   # 任务分析 API
│   │   ├── dispatch.ts                  # 任务下发 API
│   │   └── status.ts                    # 状态查询 API
│   │
│   ├── tools/
│   │   ├── cloud-fetch.ts               # 云端 HTTP 请求
│   │   ├── cloud-scrape.ts              # 云端网页抓取
│   │   ├── cloud-search.ts              # 云端搜索聚合
│   │   ├── cloud-memory.ts              # 云端记忆存储
│   │   └── cloud-analyze.ts             # 云端数据分析
│   │
│   └── agents/
│       ├── planner.ts                   # 规划 Agent
│       ├── coder.ts                     # 编码 Agent
│       ├── reviewer.ts                  # 审查 Agent
│       └── researcher.ts                # 研究 Agent
│
└── lib/
    ├── agent/
    │   ├── CloudAgentLoop.ts            # 云端 Agent 循环
    │   └── AgentRegistry.ts             # Agent 注册表
    │
    └── tools/
        └── CloudToolRegistry.ts         # 云端工具注册表
```

---

## 实现计划

### Phase 1: 基础架构 (1-2 周)

| 任务 | 说明 | 产出 |
|------|------|------|
| 1.1 TaskAnalyzer | 实现任务特征分析 | `TaskAnalyzer.ts` |
| 1.2 ExecutionRouter | 升级现有 TaskRouter，增加详细规则 | `ExecutionRouter.ts` |
| 1.3 UnifiedOrchestrator | 统一入口，串联分析→路由→执行 | `UnifiedOrchestrator.ts` |
| 1.4 LocalExecutor | 封装现有 AgentOrchestrator | `LocalExecutor.ts` |

### Phase 2: 云端工具 (2-3 周)

| 任务 | 说明 | 产出 |
|------|------|------|
| 2.1 cloud_fetch | 增强版 HTTP 请求 | `cloud-agent/api/tools/cloud-fetch.ts` |
| 2.2 cloud_scrape | 网页抓取 + 解析 | `cloud-agent/api/tools/cloud-scrape.ts` |
| 2.3 cloud_search | 多引擎搜索聚合 | `cloud-agent/api/tools/cloud-search.ts` |
| 2.4 cloud_memory | 云端向量存储 | `cloud-agent/api/tools/cloud-memory.ts` |
| 2.5 CloudToolRegistry | 云端工具注册表 | `cloud-agent/lib/tools/CloudToolRegistry.ts` |

### Phase 3: 混合协调 (2 周)

| 任务 | 说明 | 产出 |
|------|------|------|
| 3.1 HybridCoordinator | 混合模式协调器 | `HybridCoordinator.ts` |
| 3.2 WebSocket 通信 | 云端↔本地实时通信 | `WebSocketManager.ts` |
| 3.3 任务状态同步 | 进度追踪、断点续传 | `TaskSyncService.ts` |

### Phase 4: 多 Agent 云端调度 (2 周)

| 任务 | 说明 | 产出 |
|------|------|------|
| 4.1 Planner Agent | 任务规划 Agent | `cloud-agent/api/agents/planner.ts` |
| 4.2 Reviewer Agent | 代码审查 Agent | `cloud-agent/api/agents/reviewer.ts` |
| 4.3 AgentRegistry | Agent 注册和调度 | `cloud-agent/lib/agent/AgentRegistry.ts` |
| 4.4 cloud_orchestrate | 多 Agent 编排工具 | Gen7 云端增强 |

### Phase 5: 策略与演进 (1-2 周)

| 任务 | 说明 | 产出 |
|------|------|------|
| 5.1 策略同步 | 本地策略同步到云端 | Gen8 `strategy_sync` |
| 5.2 跨用户学习 | 聚合优秀策略 | 云端策略库 |
| 5.3 自动优化 | 根据反馈调整路由规则 | 路由器自优化 |

---

## 下一步

1. 确认架构设计是否符合预期
2. 讨论实现优先级和资源分配
3. 开始 Phase 1 基础架构实现
