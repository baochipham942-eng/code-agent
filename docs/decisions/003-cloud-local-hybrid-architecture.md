# ADR-003: 云端-本地混合执行架构

> 状态: accepted
> 日期: 2026-01-18

## 背景

AI Agent 需要执行多种类型的任务：文件操作、终端命令、复杂推理、多代理协同等。这些任务有不同的执行要求：
- 文件和终端操作必须在本地执行
- 复杂推理和多代理协同在云端更高效
- 某些任务需要云端规划 + 本地执行的混合模式

## 决策

采用 **云端-本地混合架构**，根据任务类型智能路由：

- **本地执行**: 文件操作、终端命令、Computer Use、敏感数据处理
- **云端执行**: 代码审查、文档生成、跨项目搜索、多代理协同
- **混合执行**: 大型重构（云端规划 → 本地执行 → 云端审查）

核心原则：
- 本地负责"手脚"（物理操作）
- 云端负责"大脑"（复杂推理）

## 选项考虑

### 选项 1: 纯本地执行
- 优点: 简单，无网络依赖，隐私保护
- 缺点: 受限于本地算力，无法跨设备协同

### 选项 2: 纯云端执行
- 优点: 算力强大，支持多代理
- 缺点: 无法执行本地文件操作，延迟高

### 选项 3: 云端-本地混合（采纳）
- 优点:
  - 充分利用云端算力处理复杂推理
  - 本地执行保证安全和隐私
  - 支持跨设备任务续接
  - 灵活的任务路由策略
- 缺点:
  - 架构复杂度增加
  - 需要处理云端-本地同步

## 后果

### 积极影响
- 复杂任务可利用云端更强的推理能力
- 敏感操作保持本地执行，保护隐私
- 支持离线时本地 fallback
- 跨设备工作流成为可能

### 消极影响
- 需要实现 TaskRouter 路由逻辑
- 混合执行模式需要协调云端和本地状态
- 增加了网络错误处理复杂度

### 风险
- 云端服务不可用时需要优雅降级
- 任务路由规则可能需要持续调优

## 实现位置

| 文件 | 职责 |
|------|------|
| `src/main/cloud/TaskRouter.ts` | 任务路由决策 |
| `src/main/cloud/CloudTaskService.ts` | 云端任务管理 |
| `src/main/cloud/HybridTaskCoordinator.ts` | 混合执行协调 |
| `src/main/services/SyncService.ts` | 云端-本地同步 |

## 当前实现状态

- ✅ 本地 Agent Loop 完整实现
- ✅ 本地多代理（Gen7 spawnAgent）
- ✅ 本地策略优化（Gen8 strategyOptimize）
- 🔲 云端任务队列（设计完成，待实现）
- 🔲 云端多代理调度（设计完成，待实现）
- 🔲 跨设备任务续接（设计完成，待实现）

## 相关文档

- [云端架构](../architecture/cloud-architecture.md)
- [Agent 核心](../architecture/agent-core.md)
