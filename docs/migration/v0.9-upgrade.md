# Migration Guide: Upgrading to v0.9

> **Status**: SCAFFOLD - Will be completed when all sessions finish Phase 1-3

This guide covers the changes and migration steps for upgrading Code Agent from v0.8.x to v0.9.0.

## Overview

Version 0.9 introduces significant improvements aligned with Claude Code architecture:

- **Security Module**: Runtime command monitoring, sensitive information detection, and audit logging
- **Tool Enhancements**: Read-before-edit enforcement, smart quote normalization, external modification detection
- **Hooks System**: User-configurable event hooks with shell scripts and AI-powered evaluation
- **Context Management**: Token estimation, incremental compression, code preservation

---

## Breaking Changes

### Configuration File Changes

#### New `.claude/settings.json` Structure

```json
{
  // Existing settings...

  // NEW: Security configuration
  "security": {
    "auditLog": {
      "enabled": true,
      "retentionDays": 30
    },
    "sensitiveDetection": {
      "enabled": true,
      "customPatterns": []
    },
    "commandMonitor": {
      "blockedPatterns": [],
      "warningPatterns": []
    }
  },

  // NEW: Hooks configuration
  "hooks": {
    "PreToolUse": [],
    "PostToolUse": [],
    "SessionStart": [],
    "SessionEnd": []
  }
}
```

#### Migration Steps

1. **Backup existing configuration**:
   ```bash
   cp ~/.claude/settings.json ~/.claude/settings.json.backup
   ```

2. **Add new sections** (the app will add defaults, but you can customize):
   - Security settings are enabled by default
   - Hooks are empty by default

---

### API Changes

#### Tool Executor Changes

The tool executor now integrates security checks:

```typescript
// Before (v0.8.x)
const result = await toolExecutor.execute('bash', { command: 'ls' });

// After (v0.9.0) - No code changes needed
// Security checks happen automatically:
// - Pre-execution validation
// - Audit logging
// - Sensitive information masking
```

#### Edit File Behavior Changes

**Read-before-edit enforcement** is now active:

```typescript
// Before (v0.8.x) - Could edit without reading
await editFile({ path: 'file.ts', oldString: 'foo', newString: 'bar' });

// After (v0.9.0) - Must read first
await readFile({ path: 'file.ts' });  // Required
await editFile({ path: 'file.ts', oldString: 'foo', newString: 'bar' });
```

**Smart quote normalization** is automatic:

```typescript
// Before (v0.8.x) - Curly quotes would fail to match
await editFile({
  path: 'file.ts',
  oldString: '"Hello"',  // Curly quotes
  newString: '"World"',
});
// Error: Old string not found

// After (v0.9.0) - Curly quotes are normalized
await editFile({
  path: 'file.ts',
  oldString: '"Hello"',  // Curly quotes
  newString: '"World"',
});
// Works! Normalized to straight quotes for matching
```

---

### New File Locations

| File/Directory | Purpose |
|----------------|---------|
| `~/.code-agent/audit/` | JSONL audit logs |
| `~/.code-agent/background-tasks.json` | Background task persistence |
| `src/main/security/` | Security module |
| `src/main/hooks/` | Hooks system |
| `src/main/context/` | Context management |

---

## New Features

### Security Module

#### Audit Logging

All tool executions are now logged to JSONL files:

```bash
# View today's audit log
cat ~/.code-agent/audit/$(date +%Y-%m-%d).jsonl | jq .
```

#### Sensitive Information Detection

Automatically detects and masks:
- API keys
- AWS credentials
- GitHub tokens
- Private keys
- Passwords in URLs
- Database connection strings

#### Command Monitoring

Configure blocked/warning patterns:

```json
{
  "security": {
    "commandMonitor": {
      "blockedPatterns": ["rm -rf /", ":(){ :|:& };:"],
      "warningPatterns": ["sudo", "chmod 777"]
    }
  }
}
```

---

### Hooks System

Create custom automation:

```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Bash",
        "hooks": [
          {
            "type": "command",
            "command": "./scripts/validate-command.sh",
            "timeout": 5000
          }
        ]
      }
    ]
  }
}
```

See [Hooks API Reference](../api-reference/hooks.md) for details.

---

### Tool Enhancements

#### External Modification Warning

When a file is modified outside Code Agent:

```
⚠️ Warning: file.ts was modified externally since you last read it.
Please re-read the file to see the latest content.
```

#### Enhanced Grep

New parameters for grep:

```typescript
grep({
  pattern: 'function',
  path: 'src/',
  afterContext: 5,   // -A 5
  beforeContext: 2,  // -B 2
  fileType: 'ts',    // --type ts
});
```

---

## Deprecations

| Deprecated | Replacement | Removal Version |
|------------|-------------|-----------------|
| None yet | - | - |

---

## Troubleshooting

### "File must be read before editing"

**Cause**: Read-before-edit enforcement is active.

**Solution**: Read the file first:
```typescript
await readFile({ path: 'file.ts' });
await editFile({ path: 'file.ts', ... });
```

### "File was modified externally"

**Cause**: External modification detection triggered.

**Solution**: Re-read the file to get latest content:
```typescript
await readFile({ path: 'file.ts' });
// Now you can edit with the latest content
```

### Audit logs consuming disk space

**Solution**: Configure retention:
```json
{
  "security": {
    "auditLog": {
      "retentionDays": 7
    }
  }
}
```

### Hook script not executing

**Checklist**:
1. Script has execute permission: `chmod +x script.sh`
2. Script path is correct (relative to project root)
3. Matcher pattern matches the tool name
4. Timeout is sufficient

---

## Version Compatibility

| Code Agent Version | Node.js | Electron |
|-------------------|---------|----------|
| 0.9.0 | >= 18.0 | 33.x |
| 0.8.x | >= 16.0 | 33.x |

---

## Getting Help

- [GitHub Issues](https://github.com/your-repo/code-agent/issues)
- [Documentation](../README.md)
- [API Reference](../api-reference/index.md)
