# 2026-02-08 Daily Log

## Claude Code vs Code Agent 对比分析

### 分析范围
- Claude Code v0.2.8 (source map 提取, Onewon/claude-code)
- Claude Code v1.0.19 (AI 逆向, apstenku123/claude-code-reverse)
- Code Agent v0.16.18-v0.16.20

### Code Agent 已有优势（超越 Claude Code）
1. **文件编辑安全链 7 层**（Claude Code 6 层）— fileReadTracker + externalModificationDetector + resourceLockManager + quoteNormalizer + atomicWrite
2. **工具并发策略已实现** — parallelStrategy.ts + executeToolsWithHooks() 正确分离读写
3. **多模型生态** — 10 个 provider，模型热切换
4. **多智能体** — 3 层混合架构（Core/Dynamic/Swarm，最多 50 并行），超越 v1.0.19 的单层 AgentTool
5. **GUI 前端** — 完整 Electron + React UI
6. **PPT 生成** — 独有能力，9 主题 137 测试
7. **代际演进框架** — Gen1~Gen8
8. **文档解析** — Excel/Word/PDF 上下文注入（Claude Code 无）
9. **引用溯源** — Citation 框架，5 种引用类型（Claude Code 无）
10. **变更追踪** — DiffTracker + Visual Diff Panel（Claude Code 无）

### v1.0.19 新增能力 vs Code Agent 覆盖情况

| v1.0.19 新能力 | Code Agent | 状态 |
|---|---|---|
| TodoWrite/TodoRead | todo_write + task (Gen3) | ✅ 已有 |
| Web Search (server-side) | web_search/web_fetch (Gen4) | ✅ 已有 |
| Auto-Compaction + 文件恢复 | autoCompressor（缺文件恢复） | ⚠️ 需补齐 |
| Sub-Agent 多 Agent | 3 层混合架构 + Swarm | ✅ 超越 |
| Extended Thinking | Adaptive Thinking + DeepSeek reasoning | ✅ 已有 |
| OAuth/PKCE 登录 | auth/ 服务 | ✅ 已有 |
| 3 种权限模式 | confirmationGate（4 策略但粒度不够） | ⚠️ 需升级 |
| Session Resume/Continue | session/ + CLI chat | ✅ 已有 |
| Model Selector + Fallback | ModelSwitcher（缺自动降级链） | ⚠️ 需补齐 |
| Config CLI 子命令 | .code-agent/settings.json | ✅ 已有 |
| Prompt Caching | 无 | ⚠️ 主力模型不支持，降 P3 |
| Cost Tracking (4 维) | BudgetService | ✅ 已有 |
| MCP 作用域 (local/user/project) | mcp.json（缺作用域分离） | ⚠️ 需补齐 |
| 3 层工具输入验证 (Schema+Custom+Permission) | toolExecutor（缺 Schema 层） | ⚠️ 需补齐 |
| IDE Diff 编辑预览 | DiffPanel（事后查看非预览） | ⚠️ 可增强 |
| Context Overflow 自动恢复 | ContextLengthExceededError（只抛不恢复） | ⚠️ 需补齐 |
| Feature Gate (Statsig) | featureFlagService | ⚠️ 需确认远程能力 |
| Clipboard Image | computer_use + screenshot | ⚠️ 部分覆盖 |
| Theme System | Tailwind + DarkMode | ⚠️ 基础 |
| GitHub App Integration | 无 | ❌ 缺失（低优先） |
| Vim-like Input | 无 | ❌ 缺失（低优先） |
| Tips of the Day | 无 | ❌ 缺失（低优先） |
| System Prompt 分块遥测 | 无 | ❌ 缺失 |

### 完整改进清单（合并 v0.2.8 + v1.0.19 分析）

| 优先级 | 改进项 | 来源 | 工作量 | 说明 |
|--------|--------|------|--------|------|
| **P0** | 权限系统升级 | v0.2.8 | 1-2天 | 命令前缀级授权 + 注入检测 + session-only 文件权限 |
| **P0** | Compaction 后文件状态 + TODO 恢复 | v1.0.19 | 1天 | 压缩后恢复最近 N 个文件内容 + TODO 状态到消息中 |
| **P1** | 自动项目上下文聚合 | v0.2.8 | 1天 | git status/branch + 递归发现 CLAUDE.md + README |
| **P1** | edit_file 返回代码片段 | v0.2.8 | 30分钟 | 编辑后返回周围 4 行 |
| **P1** | Compact 后重置 token 计数 | v0.2.8 | 1小时 | contextHealthService 重新计算 |
| **P1** | 模型降级自动切换 | v1.0.19 | 半天 | Fallback Chain: Kimi→DeepSeek→GLM |
| **P1** | 工具输入 Schema 验证 | v1.0.19 | 半天 | Zod/JSON Schema 在 execute 前验证参数类型 |
| **P1** | IDE Diff 编辑预览确认 | v1.0.19 | 1-2天 | edit_file 确认前在 DiffPanel 展示完整 diff |
| **P2** | 错误输出 head+tail 截断 | v0.2.8 | 15分钟 | 5K head + 5K tail |
| **P2** | Bash 命令 cd 前缀归一化 | v0.2.8 | 15分钟 | 去除冗余 cd $CWD && |
| **P2** | Context Overflow 自动恢复 | v1.0.19 | 半天 | 缩小 maxTokens 0.7x 后重试 |
| **P2** | MCP 作用域管理 + 审批 | v1.0.19 | 1天 | local/user/project 三级 + 项目级审批 |
| **P3** | Prompt Caching | v0.2.8 | 半天 | 仅 Anthropic provider |
| **P3** | 动态工具描述 | v0.2.8 | 半天 | GLM-4-Flash 生成命令描述 |
| **P3** | Feature Gate 远程控制 | v1.0.19 | 1-2天 | 接入 Statsig/LaunchDarkly |
| **P3** | 系统提示词分块遥测 | v1.0.19 | 半天 | 每 block 记录 hash + snippet |

### Prompt Caching 评估结论
- Moonshot/Kimi K2.5（主力）: 第三方代理，不支持
- DeepSeek: 服务端自动 prefix caching，零改动
- Zhipu: 不支持
- Anthropic: 支持但非主力模型
- **结论: 降级到 P3**

### v1.0.19 架构洞察（参考价值）
1. **内部代号 "Tengu"** — 所有遥测事件 `tengu_` 前缀
2. **递归 async generator 主循环** — 压缩→流式→工具→递归
3. **Opus→Sonnet 自动降级** — 限流后无缝切换 + 通知用户
4. **文件状态追踪** — 所有 read 文件带时间戳，压缩后选择性恢复
5. **3 层工具验证** — Schema→Custom→Permission
6. **4 维 token 成本** — input + output + cache_read + cache_write
7. **529 过载保护** — 连续 N 次 529 后自动切模型
